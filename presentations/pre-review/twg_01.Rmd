---
title: "Arrowtooth Flounder data summary"
subtitle: "AkA *'Turbot'*"
author: "Chris Grandin"
institute: "DFO"
date: "Slides compiled on `r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: ["default", "xaringan-themer.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
header-includes:
  - \usepackage{animate}
---

background-image: url(arrowtooth_flounder.jpeg)

```{r setup, include=FALSE, echo=FALSE, fig.width=8, fig.height=8}
# paste this into the console before running `xaringan::inf_mr("twg_01.Rmd")`
# to make your entries faster (fraction of a second)
# options(servr.interval = 0.1)

fig_asp <- 0.618
fig_width <- 9
fig_out_width <- "6in"
fig_dpi <- 180
fig_align <- "center"
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>",
  fig.asp = fig_asp,
  fig.width = fig_width,
  fig.path = "_bookdown_files/knitr-cache/",
  cache.path = "_bookdown_files/knitr-cache/",
  echo = FALSE,
  cache.comments = FALSE,
  dev = "png",
  dpi = fig_dpi,
  fig.align = fig_align
)

french <- FALSE

options(htmltools.dir.version = FALSE)
library(dplyr)
library(ggplot2)
#library(gfplot)
devtools::load_all(file.path(dirname(here::here()), "gfplot"))
library(arrowtooth)

main_dirs <- set_dirs(nongit_dir = file.path(dirname(here::here()), "arrowtooth-nongit"))
nongit_dir <- main_dirs$nongit_dir
if(!exists("dat")){
  dat <- readRDS(file.path(nongit_dir, "data", "arrowtooth-flounder-september-2019.rds"))
}
survey_index <- dat$survey_index
survey_sets <- dat$survey_sets
survey_samples <- dat$survey_samples
commercial_samples <- dat$commercial_samples
catch <- dat$catch
cpue_spatial <- dat$cpue_spatial
cpue_spatial_ll <- dat$cpue_spatial_ll
age_precision <- dat$age_precision

# Make a tibble in ggplot format with length-based and possibly age-based sex proportions by year
get_female_props <- function(ac = NULL, lc){
  if(!is.null(ac)){
    ac_all <- ac %>% group_by(year) %>% summarize(num = n())
    ac_fem <- ac %>% group_by(year) %>% filter(sex == "F") %>% summarize(num = n())
    ac_all <- ac_all %>%
      left_join(ac_fem, by = "year") %>% 
      rename(all = num.x, female = num.y) %>%
      mutate(female_prop = round(female / all, 2),
             male_prop = round(1 - female_prop, 2)) 
    ac_all <- ac_all %>% 
      select(year, female_prop) %>% 
      mutate(type = "Age")
  }
  
  lc_all <- lc %>% group_by(year) %>% summarize(num = n())
  lc_fem <- lc %>% group_by(year) %>% filter(sex == "F") %>% summarize(num = n())
  lc_all <- lc_all %>%
    left_join(lc_fem, by = "year") %>% 
    rename(all = num.x, female = num.y) %>%
    mutate(female_prop = round(female / all, 2),
           male_prop = round(1 - female_prop, 2)) 
  lc_all <- lc_all %>% 
    select(year, female_prop) %>% 
    mutate(type = "Length")
  
  if(is.null(ac)){
    lc_all %>% 
      rename(Year = year, `Proportion female` = female_prop, `Type` = type)
  }else{
    bind_rows(ac_all, lc_all) %>% 
      rename(Year = year, `Proportion female` = female_prop, `Type` = type)
  }
}

# Coastwide
ct_coast <- tidy_catch(catch, areas = NULL)
ct_areas <- tidy_catch(catch, areas = c("3[CD]+", "5[ABCDE]+"))
ct_areas_fine <- tidy_catch(catch, areas = c("3[CD]+", "5[AB]+", "5[CD]", "5[E]"))
ac_coast <- tidy_ages_weighted(commercial_samples, sample_type = "commercial", dat_catch = catch)
lc_coast <- tidy_lengths_weighted(commercial_samples, sample_type = "commercial", dat_catch = catch)
ac_lc_coast <- get_female_props(ac_coast, lc_coast) %>% mutate(Area = "coastwide")
lwf_coast <- gfplot::fit_length_weight(commercial_samples, sex = "female")
lwm_coast <- gfplot::fit_length_weight(commercial_samples, sex = "male")
num_m_coast <- commercial_samples %>% filter(!is.na(weight) & !is.na(length), sex == 1) %>% nrow
num_f_coast <- commercial_samples %>% filter(!is.na(weight) & !is.na(length), sex == 2) %>% nrow
# 3CD
cs_3cd <- commercial_samples %>% filter(grepl("^3[C|D].*", major_stat_area_name))
ac_3cd <- tidy_ages_weighted(cs_3cd, sample_type = "commercial", dat_catch = catch)
lc_3cd <- tidy_lengths_weighted(cs_3cd, sample_type = "commercial", dat_catch = catch)
ac_lc_3cd <- get_female_props(ac_3cd, lc_3cd) %>% mutate(Area = "3CD")
lwf_3cd <- gfplot::fit_length_weight(cs_3cd, sex = "female")
lwm_3cd <- gfplot::fit_length_weight(cs_3cd, sex = "male")
num_m_3cd <- cs_3cd %>% filter(!is.na(weight) & !is.na(length), sex == 1) %>% nrow
num_f_3cd <- cs_3cd %>% filter(!is.na(weight) & !is.na(length), sex == 2) %>% nrow
# 5AB
cs_5ab <- commercial_samples %>% filter(grepl("^5[A|B].*", major_stat_area_name))
ac_5ab <- tidy_ages_weighted(cs_5ab, sample_type = "commercial", dat_catch = catch)
lc_5ab <- tidy_lengths_weighted(cs_5ab, sample_type = "commercial", dat_catch = catch)
ac_lc_5ab <- get_female_props(ac_5ab, lc_5ab) %>% mutate(Area = "5AB")
lwf_5ab <- gfplot::fit_length_weight(cs_5ab, sex = "female")
lwm_5ab <- gfplot::fit_length_weight(cs_5ab, sex = "male", min_samples = 25)
num_m_5ab <- cs_5ab %>% filter(!is.na(weight) & !is.na(length), sex == 1) %>% nrow
num_f_5ab <- cs_5ab %>% filter(!is.na(weight) & !is.na(length), sex == 2) %>% nrow
# 5CD
cs_5cd <- commercial_samples %>% filter(grepl("^5[C|D].*", major_stat_area_name))
ac_5cd <- tidy_ages_weighted(cs_5cd, sample_type = "commercial", dat_catch = catch)
lc_5cd <- tidy_lengths_weighted(cs_5cd, sample_type = "commercial", dat_catch = catch)
ac_lc_5cd <- get_female_props(ac_5cd, lc_5cd) %>% mutate(Area = "5CD")
lwf_5cd <- gfplot::fit_length_weight(cs_5cd, sex = "female")
lwm_5cd <- gfplot::fit_length_weight(cs_5cd, sex = "male")
num_m_5cd <- cs_5cd %>% filter(!is.na(weight) & !is.na(length), sex == 1) %>% nrow
num_f_5cd <- cs_5cd %>% filter(!is.na(weight) & !is.na(length), sex == 2) %>% nrow
# 5E
cs_5e <- commercial_samples %>% filter(grepl("^5[E].*", major_stat_area_name))
lc_5e <- tidy_lengths_weighted(cs_5e, sample_type = "commercial", dat_catch = catch)
ac_lc_5e <- get_female_props(lc = lc_5e) %>% mutate(Area = "5E")
lwf_5e <- gfplot::fit_length_weight(cs_5e, sex = "female")
lwm_5e <- gfplot::fit_length_weight(cs_5e, sex = "male")
num_m_5e <- cs_5e %>% filter(!is.na(weight) & !is.na(length), sex == 1) %>% nrow
num_f_5e <- cs_5e %>% filter(!is.na(weight) & !is.na(length), sex == 2) %>% nrow

ac_lc <- bind_rows(ac_lc_coast, ac_lc_3cd, ac_lc_5ab, ac_lc_5cd, ac_lc_5e)
ggplot2::theme_set(gfplot::theme_pbs())
```

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_mono_accent(
  base_color = "#1c5253",
  header_font_google = google_font("Josefin Sans"),
  text_font_google   = google_font("Montserrat", "300", "300i"),
  code_font_google   = google_font("Fira Mono")
)
```

---
class: center, middle, inverse

# Commercial Fishery data

---
class: center
### Catch Per Unit of Effort Coastwide
```{r cpue_spatial, echo=FALSE, animation.hook="gifski", interval=2}
for(i in 2007:2019){
  g <- plot_cpue_spatial(cpue_spatial %>% filter(year == i),
                         french = french,
                         start_year = start_catch_yr,
                         bath = c(100, 200, 500, 1000, 1500)) +
    theme(axis.text.x = element_text(angle = 0)) +
    ggtitle(i) +
    theme(plot.title = element_text(size = 20, face = "bold")) +
    #theme_xaringan(background_color = "#FFFFFF") +
    scale_x_continuous(breaks = seq(from = 1900, to = 2100, by = 5))
  print(g)
}
```


---
class: center
### Total coastwide catch
```{r main-catches}
plot_catch(ct_coast, french = french, xlim = c(start_catch_yr, end_catch_yr)) +
  theme(axis.text.x = element_text(angle = 0)) +
  ggtitle(NULL) +
  scale_x_continuous(breaks = seq(from = 1900, to = 2100, by = 5))
```

---
class: center
### Total catch split North/South
```{r main-catches-by-area}
plot_catch(ct_areas, french = french, xlim = c(start_catch_yr, end_catch_yr)) +
  theme(axis.text.x = element_text(angle = 0)) +
  ggtitle(NULL) +
  scale_x_continuous(breaks = seq(from = 1900, to = 2100, by = 5))
```

---
class: center
### Total catch by area
```{r main-catches-by-area-fine}
plot_catch(ct_areas_fine, french = french, xlim = c(start_catch_yr, end_catch_yr)) +
  theme(axis.text.x = element_text(angle = 0)) +
  ggtitle(NULL) +
  scale_x_continuous(breaks = seq(from = 1900, to = 2100, by = 5))
```

---
class: center
### Number of fishery age observations
```{r age-freq}
j <- purrr::map2(list(commercial_samples, cs_3cd, cs_5ab, cs_5cd, cs_5e),
          c("Coastwide", "3CD", "5AB", "5CD", "5E"), ~{
  .x %>%
    select(year, sex, age) %>%
    filter(!is.na(age)) %>% 
    mutate(sex = ifelse(sex == 1, "Male", ifelse(sex == 2, "Female", "Not recorded"))) %>% 
              rename(Year = year, Age = age, Sex = sex) %>% 
              mutate(Area = .y)}) %>% 
  purrr::map_df(~{.x})

ggplot(j, aes(x = Year, fill = Sex, color = Sex)) +
  geom_bar() +
  scale_fill_manual(values = c(Female = "#FF00001A", Male = "#0000FF1A", `Not recorded` = "#6666661A"),
                    aesthetics = "fill") +
  scale_color_manual(values = c(Female = "red", Male = "blue", `Not recorded` = "grey40"),
                    aesthetics = "color") +
  facet_wrap(~ Area) +
  ylab("Number of length records") +
  scale_y_continuous(labels = scales::comma)
```

---
class: center
### Age proportions coastwide
```{r age-comps}
plot_ages(ac_coast) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  scale_color_manual(values = c(F = "#FF000080", M = "#0000FF80"),
                    aesthetics = "color") +
  ggtitle(NULL) +
  scale_x_continuous(breaks = seq(from = 1900, to = 2100, by = 1))
```

---
class: center
### Age proportions area 3CD
```{r age-comps-3cd}
plot_ages(ac_3cd) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  scale_color_manual(values = c(F = "#FF000080", M = "#0000FF80"),
                    aesthetics = "color") +
  ggtitle(NULL) +
  scale_x_continuous(breaks = seq(from = 1900, to = 2100, by = 1))
```

---
class: center
### Age proportions area 5AB
```{r age-comps-5ab}
plot_ages(ac_5ab) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  scale_color_manual(values = c(F = "#FF000080", M = "#0000FF80"),
                    aesthetics = "color") +
  ggtitle(NULL) +
  scale_x_continuous(breaks = seq(from = 1900, to = 2100, by = 1))
```

---
class: center
### Age proportions area 5CD
```{r age-comps-5cd}
plot_ages(ac_5cd) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  scale_color_manual(values = c(F = "#FF000080", M = "#0000FF80"),
                    aesthetics = "color") +
  ggtitle(NULL) +
  scale_x_continuous(breaks = seq(from = 1900, to = 2100, by = 1))
```

---
class: center
### Number of fishery length observations
```{r length-freq}
j <- purrr::map2(list(cs_3cd, cs_5ab, cs_5cd, cs_5e),
          c("3CD", "5AB", "5CD", "5E"), ~{
  .x %>%
    select(year, sex, length) %>%
    filter(!is.na(length)) %>% 
    mutate(sex = ifelse(sex == 1, "Male", ifelse(sex == 2, "Female", "Not recorded"))) %>% 
              rename(Year = year, Length = length, Sex = sex) %>% 
              mutate(Area = .y)}) %>% 
  purrr::map_df(~{.x})

ggplot(j, aes(x = Year, fill = Sex, color = Sex)) +
  geom_bar() +
  scale_fill_manual(values = c(Female = "#FF00001A", Male = "#0000FF1A", `Not recorded` = "#6666661A"),
                    aesthetics = "fill") +
  scale_color_manual(values = c(Female = "red", Male = "blue", `Not recorded` = "grey40"),
                    aesthetics = "color") +
  facet_wrap(~ Area) +
  ylab("Number of length records") +
  scale_y_continuous(labels = scales::comma)
```

---
class: center
### Number of fishery length observations coastwide
```{r length-freq-coastwide}
j <- commercial_samples %>% 
  select(year, sex, length) %>%
  filter(!is.na(length)) %>% 
  mutate(sex = ifelse(sex == 1, "Male", ifelse(sex == 2, "Female", "Not recorded"))) %>% 
  rename(Year = year, Length = length, Sex = sex) 

ggplot(j, aes(x = Year, fill = Sex, color = Sex)) +
  geom_bar() +
  scale_fill_manual(values = c(Female = "#FF00001A", Male = "#0000FF1A", `Not recorded` = "#6666661A"),
                    aesthetics = "fill") +
  scale_color_manual(values = c(Female = "red", Male = "blue", `Not recorded` = "grey40"),
                    aesthetics = "color") +
  ylab("Number of length records") +
  scale_y_continuous(labels = scales::comma)
```

---
class: center
### Length proportions coastwide
```{r length-comps}
fm_fill_colors <- c(M = "#0000FF1A", F = "#FF00001A")
fm_line_colors <- c(M = "blue", F = "red")
plot_lengths(lc_coast, show_year = "even", fill_col = fm_fill_colors, line_col = fm_line_colors) +
  ggtitle(NULL) +
  scale_x_continuous(breaks = seq(from = 0, to = 100, by = 5))
```

---
class: center
### Length proportions 3CD
```{r length-comps-3cd}
plot_lengths(lc_3cd, show_year = "even", fill_col = fm_fill_colors, line_col = fm_line_colors) +
  ggtitle(NULL) +
  scale_x_continuous(breaks = seq(from = 0, to = 100, by = 5))
```

---
class: center
### Length proportions 5AB
```{r length-comps-5ab}
plot_lengths(lc_5ab, show_year = "even", fill_col = fm_fill_colors, line_col = fm_line_colors) +
  ggtitle(NULL) +
  scale_x_continuous(breaks = seq(from = 0, to = 100, by = 5))
```

---
class: center
### Length proportions 5CD
```{r length-comps-5cd}
plot_lengths(lc_5cd, show_year = "all", fill_col = fm_fill_colors, line_col = fm_line_colors) +
  ggtitle(NULL) +
  scale_x_continuous(breaks = seq(from = 0, to = 100, by = 5))
```

---
class: center
### Length proportions 5E
```{r length-comps-5e}
plot_lengths(lc_5e, show_year = "all", fill_col = fm_fill_colors, line_col = fm_line_colors) +
  ggtitle(NULL) +
  scale_x_continuous(breaks = seq(from = 0, to = 100, by = 5))
```

---
class: center
### Length-weight relationships

```{r lw-relationship}
fm_color <- c(Male = "blue", Female = "red")
cowplot::plot_grid(gfplot::plot_length_weight(lwf_3cd, lwm_3cd, col = fm_color, show_legend = FALSE) +
                     ggtitle(paste0("3CD (", num_f_3cd, " F, ", num_m_3cd, " M)")),
                   gfplot::plot_length_weight(lwf_5ab, lwm_5ab, col = fm_color, show_legend = FALSE) +
                     ggtitle(paste0("5AB (", num_f_5ab, " F, ", num_m_5ab, " M)")),
                   gfplot::plot_length_weight(lwf_5cd, lwm_5cd, col = fm_color, show_legend = FALSE) +
                     ggtitle(paste0("5CD (", num_f_5cd, " F, ", num_m_5cd, " M)")),
                   gfplot::plot_length_weight(lwf_5e, lwm_5e, col = fm_color, show_legend = FALSE) +
                     ggtitle(paste0("5E (", num_f_5e, " F, ", num_m_5e, " M)")),
                   gfplot::plot_length_weight(lwf_coast, lwm_coast, col = fm_color, show_legend = FALSE) +
                     ggtitle(paste0("Coastwide (", num_f_coast, " F, ", num_m_coast, " M)")),
                   ncol = 3,
                   nrow = 2)
```

---
class: center
### Sex proportions

```{r sex_comp_compare-coast}
ggplot(ac_lc, aes(x = Year, y = `Proportion female`, color = `Type`)) +
  geom_line(size = 2) +
  geom_hline(yintercept = c(0.5, 0.75), linetype = "dashed") +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(~Area) 
  #theme_xaringan(background_color = "#FFFFFF", text_font_size = 10) 

```

---
class: center, inverse
### Gulf of Alaska assessments 2019 and 2020

.left[
- Split sex model (70% female in catch)
- Lengths used as proxy for ages
]

