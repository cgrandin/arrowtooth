---
title: "Response to requests made by the Arrowtooth TWG at the June 16, 2021 meeting"
output:
  bookdown::pdf_document2:
    toc: false
---

```{r setup, include=FALSE}
fig_asp <- 0.618
fig_width <- 9
fig_out_width <- "6in"
fig_dpi <- 180
fig_align <- "center"
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>",
  fig.asp = fig_asp,
  fig.width = fig_width,
  fig.path = "_bookdown_files/knitr-cache/",
  cache.path = "_bookdown_files/knitr-cache/",
  echo = FALSE,
  cache.comments = FALSE,
  dev = "png",
  dpi = fig_dpi,
  fig.align = fig_align
)

library(csasdown)
library(dplyr)
library(ggplot2)
library(gfplot)
library(knitr)
library(purrr)
library(tidyr)
library(kableExtra)
devtools::load_all(here::here())

main_dirs <- set_dirs(nongit_dir = file.path(dirname(here::here()), "arrowtooth-nongit"))
nongit_dir <- main_dirs$nongit_dir
if(!exists("dat")){
  dat <- readRDS(file.path(nongit_dir, "data", "arrowtooth-flounder-june11-2021.rds"))
}
pres_dir <- file.path(nongit_dir, "presentations", "pre-review")
survey_samples <- dat$survey_samples
survey_sets <- dat$survey_sets
commercial_samples <- dat$commercial_samples
```

# Request 1 - Revisit the Proportion female calculations and give more information on sample sizes used in weighting

The calculations are the same as what was done in the 2015 Stock assessment (Grandin & Forrest, 2017).

There were two small bugs found in the code that caused several proportions shown in the presentation to be unreasonable. The bugs had the effect of only the first sample in each trip being used in the calculation instead of all of them. This was the case for both the commercial and survey calculations. In addition, for the commercial data, the quarter 3 catch was used instead of the quarter 4 catch as a divisor in the weighting of the quarter 4 weights for both male and female.

The bugs were fixed and Tables \@ref(tab:sex-prop-weighting) and \@ref(tab:sex-prop-weighting-with-surveys) are the corrected versions of those that appeared in the presentation. Tables \@ref(tab:sex-prop-weighting-comm-data-summary) and \@ref(tab:sex-prop-weighting-surv-data-summary) show the number of trips, samples, and weights by sex used in the weighting calculations for commerical and survey data respectively.

```{r sex-prop-weighting, echo = FALSE, message = FALSE}
unsorted_only <- props_comm(commercial_samples,
                            areas = c("03", "04", "05", "06", "07", "08", "09"),
                            start_year = 1996,
                            end_year = 2019,
                            species_category = c(1),
                            sample_type = c(1, 2, 6, 7, 8),
                            gear = c(1, 8),
                            data_source_name = "Unsorted only")
un_keep <- props_comm(commercial_samples,
                      areas = c("03", "04", "05", "06", "07", "08", "09"),
                      start_year = 1996,
                      end_year = 2019,
                      species_category = c(1, 3),
                      sample_type = c(1, 2, 6, 7, 8),
                      gear = c(1, 8),
                      data_source_name = "Unsorted + Keepers")
un_keep_disc <- props_comm(commercial_samples,
                           areas = c("03", "04", "05", "06", "07", "08", "09"),
                           start_year = 1996,
                           end_year = 2019,
                           species_category = c(1, 3, 4),
                           sample_type = c(1, 2, 6, 7, 8),
                           gear = c(1, 8),
                           data_source_name = "Unsorted + Keepers + Discards")

j <- bind_rows(unsorted_only, un_keep, un_keep_disc) %>% 
  pivot_wider(id_cols = "year", names_from = "data_source", values_from = prop_female) %>% 
  arrange(year) %>% 
  rename(Year = year) %>% 
  mutate_at(.vars = vars(-Year), function(x){format(round(x, 2), nsmall = 2)}) %>% 
  map_df(~{
    .x[grep("NA", .x)] <- ""
    .x
  })

csas_table(j,
           align = c("l", rep("r", 4)),
           caption = "Proportions of coastwide female Arrowtooth Flounder calculated from several data sources. Note that there are no uUnsorted samples for 1997.")
```

```{r sex-prop-weighting-with-surveys, echo = FALSE, message = FALSE}
out_dir <- file.path(nongit_dir, "data-output")
fn <- file.path(out_dir, "all-proportion-female.rds")
if(!dir.exists(out_dir)){
  dir.create(out_dir)
}
if(file.exists(fn)){
  all_props <- readRDS(fn)
}else{
  all_props <- props_all(comm_samples = commercial_samples,
                         surv_sets = survey_sets,
                         surv_samples = survey_samples,
                         surv_series = 1:4,
                         surv_series_names = c("qcsss", "hsmas", "hsss", "wcviss"),
                         start_year = 1996,
                         end_year = 2019,
                         species_category = c(1),
                         sample_type = c(1, 2, 6, 7, 8),
                         gear = c(1, 8))
  saveRDS(all_props, fn)
}

all_props <- all_props %>% pivot_wider(id_cols = "year", names_from = "data_source", values_from = "prop_female") %>%
  mutate_at(.vars = vars(-year), ~{format(round(.x, 2), nsmall = 2)}) %>%
  map_df(~{
    .x[grep("NA", .x)] <- ""
    .x
  }) %>%
  rename(`Year` = "year",
         `QCS Synoptic` = "qcsss",
         `HS Multispecies` = "hsmas",
         `HS Synoptic` = "hsss",
         `WCVI Synoptic` = "wcviss")

csas_table(all_props,
           caption = "Proportions of female Arrowtooth Flounder calculated for several surveys. Note that 1997 is missing because there are no Unsorted samples for that year.")
```

```{r sex-prop-weighting-comm-data-summary, echo = FALSE, message = FALSE}
props_data <- props_comm_data_summary(
  comm_samples = commercial_samples,
  areas = c("03", "04", "05", "06", "07", "08", "09"),
  start_year = 1996,
  end_year = 2019,
  species_category = c(1),
  sample_type = c(1, 2, 6, 7, 8),
  gear = c(1, 8))

csas_table(props_data,
           caption = "Summary of the number of trips, samples, and fish weights used in the commercial coastwide proportion female calculations. Note that 1997 is missing because there are no Unsorted samples for that year.")
```

```{r sex-prop-weighting-surv-data-summary, echo = FALSE, message = FALSE}
props_surv_data <- props_surv_data_summary(
  surv_samples = survey_samples,
  surv_series = 1:4,
  surv_series_names = c("QCS Synoptic",
                        "HS Multispecies",
                        "HS Synoptic",
                        "WCVI Synoptic"))

csas_table(props_surv_data,
           caption = "Summary of the number of samples and fish weights used in the survey proportion female calculations.")
```





