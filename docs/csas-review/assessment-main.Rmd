---
title: "Arrowtooth Flounder (*Atheresthes stomias*) Stock Assessment for the West Coast of British Columbia in 2021"
subtitle: "Assessment model"
author: "C. Grandin, S. Anderson, P. English"
institute: "DFO"
date: "Slides compiled on `r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: ["default", "xaringan-themer.css", "code-custom.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: '16:9'

background-image: url(figures/arrowtooth_flounder.jpeg)

---
exclude: true
```{r setup, echo=FALSE, cache=FALSE, message=FALSE, results='hide', warning=FALSE}
library(knitr)
if (is_latex_output()) {
  knitr_figs_dir <- "knitr-figs-pdf/"
  knitr_cache_dir <- "knitr-cache-pdf/"
  fig_out_type <- "png"
} else {
  knitr_figs_dir <- "knitr-figs-docx/"
  knitr_cache_dir <- "knitr-cache-docx/"
  fig_out_type <- "png"
}
fig_asp <- 0.618
fig_width <- 8
fig_out_width <- "5.5in"
fig_dpi <- 180
fig_align <- "center"
fig_pos <- "H"
user <- Sys.info()[["user"]]
opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  results = 'hide',
  comment = "#>",
  fig.path = knitr_figs_dir,
  cache.path = knitr_cache_dir,
  fig.asp = fig_asp,
  fig.width = fig_width,
  out.width = fig_out_width,
  echo = FALSE,
  # autodep = isTRUE(user %in% "seananderson"),
  # cache = isTRUE(user %in% "seananderson"),
  cache.comments = FALSE,
  dev = fig_out_type,
  dpi = fig_dpi,
  fig.align = fig_align,
  fig.pos = fig_pos
)
options(
  # Prevent xtable from adding a timestamp comment to the table code
  # it produces
  xtable.comment = FALSE,
  # Don't allow kableExtra to load packages, we add them manually in
  # csasdown
  kableExtra.latex.load_packages = FALSE,
  # Stop chunk output (echo) running into the margins
  width = 80,
  # Don't use scientific notation (stops tables from showing 1.2e3, etc.)
  scipen = 999)
# Fixes weird bug where knitr::include_graphics() thinks the non-git folder
# is relative
options(knitr.graphics.rel_path = FALSE)
```

```{r library-setup, cache = FALSE, fig.keep='none'}
# Libraries in alphabetical order

library(devtools)
library(dplyr)
if(user == "grandin"){
  load_all("d:/github/pbs-assess/gfiscamutils")
  load_all("d:/github/pbs-assess/csasdown")
}else if(user == "seananderson"){
  library(gfiscamutils)
  load_all("~/src/gfiscamutils/")
  load_all("~/src/csasdown/")
  load_all("~/src/gfplot/")
} else {
  library(gfiscamutils)
  library(csasdown)
}
# remotes::install_github("https://github.com/pbs-assess/gfplot",ref = "arrowtooth", quiet = TRUE)
library(gfplot)
library(gfutilities)
library(ggplot2)
library(gridExtra)
library(here)
library(kableExtra)
library(purrr)
library(rosettafish)
library(tidylog, warn.conflicts = FALSE)
devtools::load_all(".")
```

```{r include = FALSE}
build_rds <- FALSE
# Don't load the models if they already exist
if(!exists("models") || !exists("drs"))
  source(here("doc/load-models.R"), local = knitr::knit_global())
```

```{r data-setup, cache.lazy = FALSE}
# This chunk requires that the chunk above that loads load-models.R is run

bc <- "British Columbia"
sp <- "Arrowtooth Flounder"
iscam <- "ISCAM"

month_fishing_starts <- 2
day_fishing_starts <- 21

data_dir <- file.path(drs$nongit_dir, "data")
data_output_dir <- file.path(drs$nongit_dir, "data-output")

if(!dir.exists(data_dir)){
  stop("Data directory does not exist: ", data_dir, call. = FALSE)
}
iphc_file <- file.path(data_dir, "iphc-survey-index.rds")
if(!file.exists(iphc_file)){
  stop("IPHC file does not exist: ", iphc_file, call. = FALSE)
}
discard_cpue_file <- file.path(data_dir,
"cpue-predictions-arrowtooth-flounder-modern-3CD5ABCDE-discard-july-26-feb-fishing-year.csv")
#"cpue-predictions-arrowtooth-flounder-modern-3CD5ABCDE-discard-july-26-jan-1-year.csv")
if(!file.exists(discard_cpue_file)){
  stop("Discard CPUE file does not exist: ", discard_cpue_file, call. = FALSE)
}
stitched_syn_file <- file.path(data_dir, "stitched-syn-index.rds")
if(!file.exists(stitched_syn_file)){
  stop("Stitched Synoptics file does not exist: ", stitched_syn_file, call. = FALSE)
}

iphc <- readRDS(iphc_file)$series_ABCD_full$ser_longest
discard_cpue <- read_csv(discard_cpue_file)
stitched_syn <- readRDS(stitched_syn_file)

dat <- readRDS(file.path(drs$nongit_dir, "data",
                         "arrowtooth-flounder-aug11-2022.rds"))

# Remove 2014 WCHG index point
wchg_2014_row <- 
  dat$survey_index$survey_abbrev == "SYN WCHG" & dat$survey_index$year == 2014
if(any(wchg_2014_row)){
  dat$survey_index <- dat$survey_index[-which(wchg_2014_row), ]
}

# These must be removed for call to add_extra_indices()
survey_index <- dat$survey_index %>% 
  select(-species_common_name, -species_science_name)
survey_index <- add_extra_indices(survey_index, 
                                  iphc = iphc,
                                  discard_cpue = discard_cpue,
                                  stitched_syn = stitched_syn)
# Survey index for geostat
geo_files <- dir(file.path(drs$nongit_dir, "survey-geostat"),
                 full.names = TRUE,
                 pattern = "^i-arrowtooth.*\\.rds$")
ind_geo <- purrr::map_dfr(geo_files, readRDS)
survey_index_geo <- ind_geo |>  filter(model == "no-depth") |> as_tibble()
survey_index_geo <- survey_index_geo |>
  rename(biomass = est,
         lowerci = lwr,
         upperci = upr,
         re = se,
         survey_abbrev = surveys) |>
  mutate(num_sets = NA,
         num_pos_sets = NA,
         survey_series_id = NA,
         survey_series_desc = "") |>
  select(-c(log_est, species, survey, ssids, ssid_string,
            family, anisotropy, spatiotemporal, share_range,
            model, max_grad)) |>
  select(year, biomass, lowerci, upperci,
         re, num_sets, num_pos_sets,
         survey_series_id, survey_abbrev, survey_series_desc) |>
  add_extra_indices(discard_cpue = discard_cpue)
# Add HS MSA survey so plot will work
hs_multi <- survey_index |> filter(survey_abbrev == "OTHER HS MSA")
survey_index_geo <- survey_index_geo |>
  bind_rows(hs_multi)

# Areas 3CD and 5ABCDE only 
major_areas <- c("03","04", "05", "06", "07", "08", "09")
tidy_areas <- c("3[CD]+", "5[ABCDE]+")
survey_sets <- dat$survey_sets |> 
  filter(major_stat_area_code %in% major_areas)
survey_samples <- dat$survey_samples |> 
  filter(major_stat_area_code %in% major_areas)
survey_samples_syn <- survey_samples |> 
  filter(survey_abbrev %in% c("SYN QCS",
                              "SYN HS",
                              "SYN WCVI",
                              "SYN WCHG"))
commercial_samples <- dat$commercial_samples |> 
  filter(major_stat_area_code %in% major_areas)
comm_ft <- extract_fleet_samples(commercial_samples)
comm_ss <- extract_fleet_samples(commercial_samples, include = FALSE)

# Aggregated commercial catch
month_start <- 2
day_start <- 21
dat$catch <- dat$catch |> filter(year < 2022)
catch <- tidy_catch(dat$catch,
                    areas = tidy_areas,
                    month_fishing_starts = month_start,
                    day_fishing_starts = day_start)
# Catch by fleet
catch_ft <- extract_fleet_catch(dat$catch) |> 
  tidy_catch(areas = tidy_areas,
             month_fishing_starts = month_start,
             day_fishing_starts = day_start)

catch_ss <- extract_fleet_catch(dat$catch, include = FALSE) |> 
  tidy_catch(areas = tidy_areas,
             month_fishing_starts = month_start,
             day_fishing_starts = day_start)

cpue_spatial <- dat$cpue_spatial
cpue_spatial_ll <- dat$cpue_spatial_ll
age_precision <- dat$age_precision

theme_set(gfiscam_theme())

# Gear names are set in the data file for each model
gear_names <- models$base_model[[1]]$dat$gear_names
if(fr()){
  # Translate all gear names to French
  # Note 'Shoreside' is the same in both languages 
  gear_names_fr <- map_chr(gear_names, ~{
    if(.x == "HS Multispecies Assemblage"){
      return("HS Assemblage multi-espÃ¨ces")
    }
    if(grepl("Synoptic", .x)){
      j <- str_split(.x, " ")[[1]]
      paste(j[1], tr(j[2]))
    }else{
      tr(.x)
    }
  })
  
  models$base_model <- 
    replace_gear_names(models$base_model,
                       old_gear_names = gear_names,
                       new_gear_names = gear_names_fr)
  models$bridge_grps[[1]] <- 
    replace_gear_names(models$bridge_grps[[1]],
                       old_gear_names = gear_names,
                       new_gear_names = gear_names_fr)
  models$bridge_grps[[2]] <- 
    replace_gear_names(models$bridge_grps[[2]],
                       old_gear_names = gear_names,
                       new_gear_names = gear_names_fr)
}

base_model <- models$base_model[[1]]

base_all_gears <- gear_lu_table(base_model, "all")
base_age_gears <- gear_lu_table(base_model, "age")
base_index_gears <- gear_lu_table(base_model, "index")
base_fleet_gears <- gear_lu_table(base_model, "fleet")

mcmc_chain_length <- 10000000
mcmc_num_samples <- 2000
mcmc_sample_freq <- mcmc_chain_length / mcmc_num_samples
mcmc_burn_in <- 1000
mcmc_actual_samples <- mcmc_num_samples - mcmc_burn_in

qcs <- "Queen Charlotte Sound Synoptic Survey"
hsmas <- "Hecate Strait Multispecies Assemblage Survey"
hss <- "Hecate Strait Synoptic Survey"
wcvis <- "West Coast Vancouver Island Synoptic Survey"
wchgs <- "West Coast Haida Gwaii Synoptic Survey"
dcpue <- "Discard CPUE Index"

la <- "2015 assessment"
# tv_block1 <- paste0(unique(filter(base_model$mcmccalcs$selest_quants,
#                                   gear == "QCS Synoptic", block == 1)$start_year),
#                     "--", 
#                     unique(filter(base_model$mcmccalcs$selest_quants,
#                                   gear == "QCS Synoptic", block == 1)$end_year))
# tv_block2 <- paste0(unique(filter(base_model$mcmccalcs$selest_quants,
#                                   gear == "QCS Synoptic", block == 2)$start_year),
#                     "--", 
#                     unique(filter(base_model$mcmccalcs$selest_quants,
#                                   gear == "QCS Synoptic", block == 2)$end_year))

# Text for selectivity block year ranges
# qcs_tv_yr_start <- base_model$ctl$start.yr.time.block[3, ]
# qcs_tv_yr_start[1] <- base_model$dat$start.yr
# qcs_tv_yr_end <- c(qcs_tv_yr_start[2:length(qcs_tv_yr_start)] - 1,
#                    base_model$dat$end.yr)
# if(length(qcs_tv_yr_start) == 2){
#   qcs_sel_ranges <- paste(paste0(qcs_tv_yr_start, "-", qcs_tv_yr_end),
#                           collapse = " and ")
# }else{
#   qcs_sel_ranges <- paste0(qcs_tv_yr_start, "-", qcs_tv_yr_end)
#   tmp <- qcs_sel_ranges[length(qcs_sel_ranges)]
#   qcs_sel_ranges <- paste(qcs_sel_ranges[-length(qcs_sel_ranges)],
#                           collapse = ", ")
#   qcs_sel_ranges <- paste0(qcs_sel_ranges, ", and ", tmp)
# }

# Number of parameters estimated (from PAR file)
num_params <- get_num_params_est(base_model)

# Catch table
ct <- as_tibble(base_model$dat$catch)
ct_start_yr <- min(ct$year)
ct_end_yr <- max(ct$year)

# Reference points (table values)
ref_pts <- as_tibble(base_model$mcmccalcs$params_quants)

# Projected biomass
end_yr <- base_model$dat$end.yr
assess_yr <- end_yr + 1
proj_yr <- assess_yr + 1
sbt_quants <- as_tibble(base_model$mcmccalcs$sbt_quants)
proj_bio <- sbt_quants[, as.character(assess_yr)] |> pull()

# Fishing mortality
f_max_by_gear <- map_dbl(base_model$mcmccalcs$ft_quants, ~{
  max(.x[2,])
})
f_max <- max(f_max_by_gear)
which_f_max <- which(f_max == f_max_by_gear)
which_f_max_gear <- base_model$dat$fleet_gear_names[which_f_max]
which_f_max_yr <- names(which(base_model$mcmccalcs$ft_quants[[which_f_max]][2, ] == f_max))

f_ci <- base_model$mcmccalcs$ft_quants[[which_f_max]][, base_model$mcmccalcs$ft_quants[[which_f_max]][2, ] == f_max]

# Relative spawning biomass
depl_end <- as_tibble(base_model$mcmccalcs$depl_quants) |>
  select(!!sym(as.character(assess_yr))) |> 
  pull()

# Decision table values - B_2023 < B_2022
table_dec <- table_decisions(base_model, ret_df = TRUE, digits = 3)
probs_catch_0 <- table_dec |> filter(`Catch (thousand t)` == 0) |> unlist()
probs_catch_10 <- table_dec |> filter(`Catch (thousand t)` == 10) |> unlist()
probs_catch_50 <- table_dec |> filter(`Catch (thousand t)` == 50) |> unlist()
prob_proj_less_assess_0 <- probs_catch_0[length(probs_catch_0)]
prob_proj_less_assess_10 <- probs_catch_10[length(probs_catch_10)]
prob_proj_less_assess_50 <- probs_catch_50[length(probs_catch_50)]

probs_proj_less_assess <- table_dec[, ncol(table_dec)] |>
  pull() |> 
  as.numeric()
which_prob_less_50_50 <- which(probs_proj_less_assess < 0.5)
which_prob_less_50_50 <- which_prob_less_50_50[length(which_prob_less_50_50)]
prob_less_50_50 <- table_dec[which_prob_less_50_50, ]
prob_greater_50_50 <- table_dec[which_prob_less_50_50 + 1, ]

val_less_50_50 <- pull(prob_less_50_50[, ncol(prob_less_50_50)])

# Decision table values - B_2023 < 0.4B0
below_04bo <- table_dec |> 
  select(paste0(proj_yr, "_04bo")) |> 
  pull() |> 
  as.numeric()
range_below_04bo <- c(min(below_04bo), max(below_04bo))

# Decision table values - B_2023 < 0.2B0
below_02bo <- table_dec |> 
  select(paste0(proj_yr, "_02bo")) |> 
  pull() |> 
  as.numeric()
range_below_02bo <- c(min(below_02bo), max(below_02bo))
which_prob_greater_50_50_02bo <- which(below_02bo > 0.5)[1]
prob_greater_50_50_02bo <- below_02bo[which_prob_greater_50_50_02bo]
row_greater_50_50_02bo <- table_dec[which_prob_greater_50_50_02bo, ]

# Decision table values - B_2023 < 0.8BMSY
# below_08bmsy <- table_dec |> 
#   select(paste0(proj_yr, "_08bmsy")) |> 
#   pull() |> 
#   as.numeric()
# range_below_08bmsy <- c(min(below_08bmsy), max(below_08bmsy))

# Decision table values - B_2023 < 0.4BMSY
# below_04bmsy <- table_dec |> 
#   select(paste0(proj_yr, "_04bmsy")) |> 
#   pull() |> 
#   as.numeric()
#range_below_04bmsy <- c(min(below_04bmsy), max(below_04bmsy))
```

```{r biological-params}

find_length_outliers <- function(xx) {
  yy <- stats::pnorm(xx,
    mean = mean(xx, na.rm = TRUE),
    sd = stats::sd(xx, na.rm = TRUE), log.p = TRUE
  )
  zz <- stats::qnorm(yy, log.p = TRUE)
  out <- zz[zz > 4 & !is.na(zz)]
  if (length(out) > 1L) {
    return(xx[which(zz > 4)])
  } else {
    return(numeric(0))
  }
}

length_samples_survey <- filter(
  dat$survey_samples,
  !length %in% find_length_outliers(dat$survey_samples$length)
)

length_samples_ft <- filter(
  comm_ft,
  !length %in% find_length_outliers(comm_ft$length)
)

length_samples_ss <- filter(
  comm_ss,
  !length %in% find_length_outliers(comm_ss$length)
)

all_length_samples <- bind_rows(length_samples_survey, length_samples_ft, length_samples_ss)

all_age_samples <- bind_rows(dat$survey_samples, comm_ft, comm_ss) %>%
  filter(!is.na(age) & age < 40)
# it seems there's one extreme outlier... 50 y, also size and sex wouldn't make sense so definite error

# TODO: should the reported values (and coastwide plot) be for just from the 4 trawl surveys combined? Doesn't seem to fit as well if commercial samples added. 
#vb_m <- fit_vb(dat$survey_samples %>% filter(survey_series_id %in% c(1, 3, 4, 16)), 
#               sex = "male", method = "tmb", too_high_quantile = 1)

#vb_f <- fit_vb(dat$survey_samples %>% filter(survey_series_id %in% c(1, 3, 4, 16)), 
#               sex = "female", method = "tmb", too_high_quantile = 1)

#mat_fit <- fit_mat_ogive(dat$survey_samples %>% filter(survey_series_id %in% c(1, 3, 4, 16)), 
#                         type = "age", sample_id_re = TRUE, year_re = FALSE)
#                     
# Use function from this package as it is (very) slightly different than what 
# fit_mat_ogive() returns, and is what is input into the model
mat_fit <- export_mat_lw_age(dat$survey_samples, write_file = FALSE)
# TODO: what random effects wanted? If year, than params are saved as mat_fit$mat_perc$mean$f.mean.p0.5 and mat_fit$mat_perc$mean$m.mean.p0.5 instead of mat_fit$mat_perc$f.p0.5 and mat_fit$mat_perc$m.p0.5. I assume fig:fig-mat should also be made to match 

# Natural mortality values in the control file

param_ctl_table <- models$bridge_grps[[3]][[2]]$ctl$params |> as_tibble(rownames = "param")
male_m_ctl <- exp(param_ctl_table |> filter(param == "log_m_male") |> pull(ival))
female_m_ctl <- exp(param_ctl_table |> filter(param == "log_m_female") |> pull(ival))
```

```{r proportion-female}

if(!exists("data_dir")){
  stop("`data_dir` does not exist. If running from command line, ",
       "source('index.Rmd') to set up all project variables", call. = FALSE)
}

prop_female_fn <- file.path(data_dir, "prop_female_output.rds")
if(file.exists(prop_female_fn)){
  prop_female_lst <- readRDS(prop_female_fn)
}else{
  comm_prop <- props_comm(dat$commercial_samples)
  surv_prop <- props_surv(surv_series = c(1, 3, 4, 16),
                          surv_series_names = c("qcsss", "hsss", "wcviss", "wchgss"),
                          surv_samples = dat$survey_samples,
                          surv_sets = dat$survey_sets)
  prop_female_lst <- list(comm_prop, surv_prop)
  saveRDS(prop_female_lst, prop_female_fn)
}

prop_female_table <- table_prop_female(prop_female_lst, return_df = TRUE)
total_prop_female <- f(tail(prop_female_table, 1)[-1] |>
                         unlist() |>
                         as.numeric() |>
                         mean(),
                       2)
```

```{r model-param-value-calcs}

base_sbo <- get_parvals(base_model, "sbo")
base_bo <- get_parvals(base_model, "bo")
base_sbt <- get_parvals(base_model, "sbt")
base_depl <- get_parvals(base_model, "depl", digits = 2)
base_m_male <- get_parvals(base_model, "m_male", digits = 2)
base_m_female <- get_parvals(base_model, "m_female", digits = 2)
base_h <- get_parvals(base_model, "h", digits = 2)

bvals <- get_group_parvals(models$bridge_grps)
svals <- get_group_parvals(models$sens_grps)
# Now, to get the b0 median for the first sensitivity model in the third model group:
# Note you ave to skip the first one in each group because it is the base model
# svals[[3]][[2]]$bo[1]
# b0 CI range:
# svals[[3]][[2]]$bo[2]
# sbt median:
# svals[[3]][[2]]$sbt[1]
# sbt CI range:
# svals[[3]][[2]]$sbt[2]
# sbt end year:
# svals[[3]][[2]]$sbt[3

# Extract parameter values from the table found in the control file
#
# @param model The iSCAM model
# @param param The parameter name (row)
# @param value The value (column)
# @param digits The number of decimal points to return
#
# @return The value or row
# @export
get_ctl_params <- function(model, param = NULL, value = NULL, ...){
  inp_params <- as_tibble(rownames_to_column(as.data.frame(model$ctl$params),
                                             var = "param"))

  if(!is.null(param)){
    inp_params <- filter(inp_params, param == !!param)
  }
  if(!is.null(value)){
    return(pull(inp_params, value))
  }
  inp_params
}

get_param_est <- function(model, param = NULL, est_digits = 2, html = FALSE, ...){
  if(is.null(param)){
    stop("Must provode `param` name", call. = FALSE)
  }
  
  if(param == "log_m_female"){
    param ="m_sex1"
  }
  if(param == "log_m_male"){
    param ="m_sex2"
  }
  raw <- as_tibble(model$mcmccalcs$params_quants)[[param]]
  paste0(f(raw[2], est_digits),
         " (",
         f(raw[1],
           est_digits),
         ifelse(html, "&ndash;", "--"),
         f(raw[3],
           est_digits),
         ")")
}

get_param_vals <- function(model, param, est = TRUE, ...){
  out <- NULL
  out$init <- get_ctl_params(model, param, "ival", ...)
  out$p1 <- get_ctl_params(model, param, "p1", ...)
  out$p2 <- get_ctl_params(model, param, "p2", ...)
  if(est){
    out$est <- get_param_est(model, param, ...)
  }
  out
}

base_vartheta <- get_param_vals(base_model, "vartheta", est = FALSE, digits = 5)
base_rho <- get_param_vals(base_model, "rho", est = FALSE, digits = 5)
base_sig_tau <- calc_sig_tau(get_param_vals(base_model, "rho", est = FALSE)$init,
                             get_param_vals(base_model, "vartheta", est = FALSE)$init)
base_sig <- f(base_sig_tau[1], 1)
base_tau <- f(base_sig_tau[2], 1)

base_h <- get_param_vals(base_model, "h")
base_h_prior1 <- calc_beta_mean_cv(base_h$p1, base_h$p2)[1]
base_h_prior2 <- calc_beta_mean_cv(base_h$p1, base_h$p2)[2]
base_h_prior_params <- paste(f(base_h_prior1, 2),
                             ",",
                             f(base_h_prior2, 2))
base_m_female <- get_param_vals(base_model, "log_m_female")
base_m_male <- get_param_vals(base_model, "log_m_male")

sens_1_2_vartheta <- get_param_vals(models$sens_grps[[1]][[2]], "vartheta")
sens_1_2_rho <- get_param_vals(models$sens_grps[[1]][[2]], "rho", est = FALSE)
sens_1_2_sig_tau <- calc_sig_tau(get_param_vals(models$sens_grps[[1]][[2]],
                                                           "rho", est = FALSE)$init,
                                 get_param_vals(models$sens_grps[[1]][[2]],
                                                           "vartheta")$init)
sens_1_2_sig <- f(sens_1_2_sig_tau[1], 3)
sens_1_2_tau <- f(sens_1_2_sig_tau[2], 1)
sens_1_2_h <- get_param_vals(models$sens_grps[[1]][[2]], "h")
sens_1_2_sbo <- get_param_vals(models$sens_grps[[1]][[2]], "sbo")

sens_1_3_vartheta <- get_param_vals(models$sens_grps[[1]][[3]], "vartheta")
sens_1_3_rho <- get_param_vals(models$sens_grps[[1]][[3]], "rho", est = FALSE)
sens_1_3_sig_tau <- calc_sig_tau(get_param_vals(models$sens_grps[[1]][[3]],
                                                           "rho", est = FALSE)$init,
                                 get_param_vals(models$sens_grps[[1]][[3]],
                                                           "vartheta")$init)
sens_1_3_sig <- f(sens_1_3_sig_tau[1], 1)
sens_1_3_tau <- f(sens_1_3_sig_tau[2], 1)
sens_1_3_sbo <- get_param_vals(models$sens_grps[[1]][[3]], "sbo")


sens_1_4_vartheta <- get_param_vals(models$sens_grps[[1]][[4]], "vartheta")
sens_1_4_rho <- get_param_vals(models$sens_grps[[1]][[4]], "rho", est = FALSE)
sens_1_4_sig_tau <- calc_sig_tau(get_param_vals(models$sens_grps[[1]][[4]],
                                                           "rho", est = FALSE)$init,
                                 get_param_vals(models$sens_grps[[1]][[4]],
                                                           "vartheta")$init)
sens_1_4_sbo <- get_param_vals(models$sens_grps[[1]][[4]], "sbo")

sens_1_4_sig <- f(sens_1_4_sig_tau[1], 1)
sens_1_4_tau <- f(sens_1_4_sig_tau[2], 1)

sens_1_5_h <- get_param_vals(models$sens_grps[[1]][[5]], "h")
sens_1_5_h_prior1 <- calc_beta_mean_cv(sens_1_5_h$p1, sens_1_5_h$p2)[1]
sens_1_5_h_prior2 <- calc_beta_mean_cv(sens_1_5_h$p1, sens_1_5_h$p2)[2]
sens_1_5_h_prior_params <- paste(f(sens_1_5_h_prior1, 2),
                             ",",
                             f(sens_1_5_h_prior2, 2))

sens_2_2_m_female <- get_param_vals(models$sens_grps[[2]][[2]], "log_m_female")
sens_2_3_m_female <- get_param_vals(models$sens_grps[[2]][[3]], "log_m_female")
sens_2_4_m_male <- get_param_vals(models$sens_grps[[2]][[4]], "log_m_male")
sens_2_5_m_male <- get_param_vals(models$sens_grps[[2]][[5]], "log_m_male")

# qk priors and estimates
base_qk_inp_params <- base_model$ctl$surv.q
base_qk_mean <- exp(base_qk_inp_params[rownames(base_qk_inp_params) == "priormeanlog"])[1]
base_qk_sd <- base_qk_inp_params[rownames(base_qk_inp_params) == "priorsd"][1]

sens_qk_inp_params <- models$sens_grps[[3]][[2]]$ctl$surv.q
sens_qk_mean <- exp(sens_qk_inp_params[rownames(sens_qk_inp_params) == "priormeanlog"])[1]
sens_qk_sd <- sens_qk_inp_params[rownames(sens_qk_inp_params) == "priorsd"][1]

sens_qkp_inp_params <- models$sens_grps[[3]][[3]]$ctl$surv.q
sens_qkp_mean <- exp(sens_qkp_inp_params[rownames(sens_qkp_inp_params) == "priormeanlog"])[1]
sens_qkp_sd <- sens_qkp_inp_params[rownames(sens_qkp_inp_params) == "priorsd"][1]

sens_3_2_selex_f_qcs <- filter(models$sens_grps[[3]][[2]]$mcmccalcs$selest_quants, gear == "QCS Synoptic", sex == 2)$a_hat
sens_3_2_selex_f_qcs_mean_ci <- paste0(f(sens_3_2_selex_f_qcs[2], 1),
                                       " (",
                                       f(sens_3_2_selex_f_qcs[1], 1),
                                       "--",
                                       f(sens_3_2_selex_f_qcs[3], 1),
                                       ")")

# This is a hard coded value in the abstract (percentage of posteriors below the 0.2B0 LRP)
prob_below_02_sbo_2022 <- sum(unlist(base_model$mcmccalcs$depl[, ncol(base_model$mcmccalcs$depl)]) < 0.2) / 
  nrow(base_model$mcmccalcs) * 100

split_sex_model_sel <- models$bridge_grps[[2]][[4]]$mcmccalcs$selest_quants |> filter(gear == "QCS Synoptic", sex == 2)
split_sex_model_sel_ahat <- paste0(f(split_sex_model_sel$a_hat[2]), " (", 
                                   f(split_sex_model_sel$a_hat[1]), "--",
                                   f(split_sex_model_sel$a_hat[3]), ")")
split_sex_model_sel_ghat <- paste0(f(split_sex_model_sel$g_hat[2]), " (", 
                                   f(split_sex_model_sel$g_hat[1]), "--",
                                   f(split_sex_model_sel$g_hat[3]), ")")
split_sex_model_sel_ahat_html <- paste0(f(split_sex_model_sel$a_hat[2]), " (", 
                                        f(split_sex_model_sel$a_hat[1]), "&ndash;",
                                        f(split_sex_model_sel$a_hat[3]), ")")
split_sex_model_sel_ghat_html <- paste0(f(split_sex_model_sel$g_hat[2]), " (", 
                                        f(split_sex_model_sel$g_hat[1]), "&ndash;",
                                        f(split_sex_model_sel$g_hat[3]), ")")

split_sex_model_sel_wchg_male <- models$bridge_grps[[2]][[4]]$mcmccalcs$selest_quants |>
  filter(gear == "WCHG Synoptic", sex == 1)
split_sex_model_sel_wchg_female <- models$bridge_grps[[2]][[4]]$mcmccalcs$selest_quants |>
  filter(gear == "WCHG Synoptic", sex == 2)
split_sex_model_sel_ahat_wchg_female_html <- paste0(f(split_sex_model_sel_wchg_female$a_hat[2]), " (", 
                                                    f(split_sex_model_sel_wchg_female$a_hat[1]), "&ndash;",
                                                    f(split_sex_model_sel_wchg_female$a_hat[3]), ")")
split_sex_model_sel_ahat_wchg_male_html <- paste0(f(split_sex_model_sel_wchg_male$a_hat[2]), " (", 
                                                  f(split_sex_model_sel_wchg_male$a_hat[1]), "&ndash;",
                                                  f(split_sex_model_sel_wchg_male$a_hat[3]), ")")

estimated_female_m_remove_wchg <- get_param_vals(models$bridge_grps[[3]][[2]], "log_m_female", html = TRUE)
estimated_male_m_remove_wchg <- get_param_vals(models$bridge_grps[[3]][[2]], "log_m_male", html = TRUE)

vuln_ratio_yr <- as.character(end_yr)
base_vuln_bio <-
  base_model$mcmccalcs$vbt_quants[[1]][, vuln_ratio_yr][2] + base_model$mcmccalcs$vbt_quants[[2]][, vuln_ratio_yr][2]

base_model_bio <- base_model$mcmccalcs$sbt_quants[, vuln_ratio_yr][2]
base_model_vuln_ratio <- base_vuln_bio / base_model_bio

sel_eq_mat_vuln_bio <-
  models$sens_grps[[4]][[2]]$mcmccalcs$vbt_quants[[1]][, vuln_ratio_yr][2] + models$sens_grps[[4]][[2]]$mcmccalcs$vbt_quants[[2]][, vuln_ratio_yr][2]

sel_eq_mat_bio <- models$sens_grps[[4]][[2]]$mcmccalcs$sbt_quants[, vuln_ratio_yr][2]

sel_eq_mat_vuln_ratio <- sel_eq_mat_vuln_bio / sel_eq_mat_bio

theme_set(theme_pbs())
```

<!-- ---------------------------------------------------------------------- -->
```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_mono_accent(
  base_color = "#1c5253",
  header_font_google = google_font("Josefin Sans"),
  text_font_google   = google_font("Montserrat", "300", "300i"),
  code_font_google   = google_font("Fira Mono")
)
```

---
class: center, bg_arf
### Outline

.left[

- Introduction (biology and differences from last assessment)
- Management history, areas and spatial catch
- Data
  - Catch, Length, Age
  - Indices of Abundance
  - Growth parameters (fit outside assessment model)
  - Proportion female
- Bridge models
- Assessment model fits/estimates
  - Index fits, Age fits/residuals, Selectivity
  - Posterior distributions of MSY-based reference points
  - MCMC diagnostics
- Retrospective models
- Sensitivity models
- Projections and decision tables
- Summary
]
<div class="footer" id="a">
  <a href="https://www.seafoodwatch.org/recommendation/flounder/arrowtooth-flounder-525">Photo Source</a>
</div>

---
class: center, bg_arf_face_close
### Introduction

.left[
**`r sp`**
- are a flatfish that occurs in the offshore waters of `r bc`;
- mostly feed on Capelin, Euphausiids, Walleye Pollock, Pandalid shrimp, Herring, and other forage fish;
- are prey for mostly Pacific Cod, Pacific Halibut, and Steller sea lions; for juveniles, adult `r sp` and Walleye Pollock;
- are primarily caught by bottom trawl fishery, and sometimes by hook and line in the Halibut fishery;
- must be frozen shortly after catching due to proteolysis of the flesh;
- seasonal vertical migration to deeper water in winter, shallower in summer; and
- spawn and hatch in deeper water (>350m), in winter.

**The `r la` model**
- included data from 1996-2014 and
- was done with a model which was female only and had a single commercial trawl fleet.
- Link to the .link-style1[[Research document](https://www.dfo-mpo.gc.ca/csas-sccs/Publications/ResDocs-DocRech/2017/2017_025-eng.html)]

**The 2021 assessment model**
- includes data from 1996-2021;
- includes 3 synoptic surveys (QCS, HS, and WCVI) and
- is split by sex, and has two commercial trawl fleets (Freezer trawlers and Shoreside).
]
<div class="footer" id="a">
  <a href="https://www.flickr.com/photos/77659781@N00/6150221707">Photo Source</a>
</div>

---
class: center
### Management

.left[
**`r sp`**
- are managed as a coastwide stock;
- had no limits on catch prior to 2006;
- had a TAC of 15,000 t in place from 2006-2017;
- had the TAC increased to 17,500 t in 2017 and
- had the TAC decreased to 14,000 t in 2019.

On Jan. 30, 2020, late changes to the Integrated Fisheries Management Plan (IFMP) to address declining abundance in the synoptic surveys were recommended. These changes included:
- reducing 2020/2021 TAC from 14,000 t to 5,000 t;
- reducing 2019/2020 carryover allowance from 30% to 10%;
- reducing the amount of temporary quota a license can hold from 16% to 8% of TAC and
- implementing new spatial closures from Nov. 1 to Mar. 31 to limit harvesting of spawning aggregations.

.link-style1[[IFMP for Groundfish](https://www.pac.dfo-mpo.gc.ca/fm-gp/mplans/ground-fond-ifmp-pgip-sm-eng.html)]
]

---
class: center
### Management Areas and catch
```{r management-areas, out.width = 900}
plot_catch_spatial(dat$catch_spatial, 
                   show_majorbound = TRUE, 
                   # major_labels = labels,
                   start_year = base_model$dat$start.yr,
                   fill_scale = scale_fill_viridis_c(trans = "log10", option = "D"),
                   colour_scale = scale_colour_viridis_c(trans = "log10", option = "D"))

```

---
class: center
### Catch data

.left[
**Catch for `r sp`**
- had no discard reporting prior to 1996, when observers were introduced. Entire tows were often discarded without report;
- continued to be discarded at sea in great numbers until the arrival of freezer trawlers in the mid 2000's, which could freeze their catch at sea and avoid proteolysis;
- had large declines recently (2020-2021) which was due to TAC reductions
- was dominated by Freezer trawlers in the last decade.

**Notes on catch**
- The commercial fishing year for `r sp` starts on Feb 21 and ends on Feb 20. All yearly catch data in this assessment were aggregated in this way.

- Historical catch reconstruction was not attempted due to the unreported discards at sea prior to 1996.

- The large spike in 2005 catch was from a test fishery that took place in area 5D. There was an immediate drop the next year due to lack of profitability of the fishery, likely due to proteolysis and lack of freezers at sea.
]

---
class: center
### Catch by area
```{r catch-by-area, out.width = 900}
yrs <- sort(unique(catch$year))
plot_catch(catch, french = fr(), xlim = c(min(yrs), max(yrs))) +
  scale_x_continuous(yrs, breaks = seq(min(yrs), yrs[length(yrs)], by = 2)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.55, vjust = 0.5))

```

---
class: center
### Catch by fleet

```{r catch-by-fleet, out.width = 900}
yrs <- sort(unique(catch$year))
plot_catch_fleet(list(catch_ft, catch_ss),
                 base_model$dat$fleet_gear_names,
                 french = fr(),
                 xlim = c(min(yrs), max(yrs))) +
  scale_x_continuous(yrs, breaks = seq(min(yrs), yrs[length(yrs)], by = 2)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.55, vjust = 0.5))

```

---
class: center
### Length data

```{r length-data, out.width = 900}

bin_width1 <- diff(quantile(length_samples_survey$length,
                            na.rm = TRUE,
                            probs = c(0, 1))) / 20

bin_width2 <- diff(quantile(length_samples_ft$length,
                            na.rm = TRUE, probs = c(0, 1))) / 20

bin_width3 <- diff(quantile(length_samples_ss$length,
                            na.rm = TRUE, probs = c(0, 1))) / 20

bin_width <- mean(c(bin_width1, bin_width2, bin_width3),
                  na.rm = TRUE)

ss <- tidy_lengths_weighted(length_samples_survey,
                            dat_survey_sets = dat$survey_sets,
                            bin_size = bin_width,
                            sample_type = "survey")

sf <- length_samples_ft |> 
  # mutate(sex = 2) |>  # fake all sex as female for commercial samples; often not sexed
  tidy_lengths_weighted(dat_catch = dat$catch,
                        bin_size = bin_width,
                        sample_type = "commercial",
                        spp_cat_code = 1) |> 
  mutate(survey_abbrev = "Freezer Trawlers")

sc <- length_samples_ss |> 
  # mutate(sex = 2) %>% # fake all sex as female for commercial samples; often not sexed
  tidy_lengths_weighted(dat_catch = dat$catch,
                        bin_size = bin_width,
                        sample_type = "commercial",
                        spp_cat_code = 1) |> 
  mutate(survey_abbrev = "Shoreside")

min_total <- 20

sc_old <- filter(sc, year < 1995) # are we interested in length frequencies pre-1980?
sc <- filter(sc, year > 1995)
sb <- suppressWarnings(bind_rows(ss, sc, sf))
sb$survey_abbrev <- factor(sb$survey_abbrev,
                           levels = c("SYN WCHG",
                                      "SYN HS",
                                      "SYN QCS",
                                      "SYN WCVI",
                                      tr("Freezer Trawlers"),
                                      tr("Shoreside")))

sb$year <- factor(sb$year, levels = seq(1996, 2021))

g_lengths <- plot_lengths(sb,
  fill_col = c("M" = "#0096FF10", "F" = "#FF000010"),
  line_col = c("M" = "#0000FF", "F" = "#FF0000"),
  survey_cols = NULL,
  # survey_cols = stats::setNames(
  #   c("#FC8D62", "#FC8D62", "#FC8D62", "#FC8D62", 
  #     "#0096FF", "#0096FF"),
  #     # "#4682B4", "#4682B4"),
  #   c(
  #     "SYN WCHG", "SYN HS", "SYN QCS", "SYN WCVI",
  #     tr("Freezer Trawlers"),
  #     tr("Shoreside")
  # )
  # ),
  bin_size = bin_width, min_total = min_total
) +
  # scale_x_continuous(breaks = x_breaks, labels = x_labels) +
  guides(colour = "none", fill = "none") +
  ggtitle("") +
  xlab(paste(tr("Length"), "(cm)")) +
  ylab(tr("Relative length frequency")) +
  theme(strip.text.y.right = element_text(angle = 0))

g_lengths
```

---
class: center, bg_arf_pencil
### Age data
.left[
Age data were
- recorded using break-and-bake method where a whole tray of otoliths are baked and then individually broken and rings counted;

- chosen randomly across many vessels for the commercial trawl fishery;

- included for both commercial fleets and three synoptic surveys;

- input into the model as weighted proportions-at-age using the methods of Holt et. al (2016) and the 2015 Arrowtooth assessment. This method is coded into the `weight_comps()` function located in the .link-style1[[gfplot R package](https://github.com/pbs-assess/gfplot)].
]
<div class="footer" id="a">
  <a href="https://stock.adobe.com/images/arrowtooth-flounder-atheresthes-stomas-a-flatfish-from-the-north-pacific-in-top-view/317577516?as_campaign=ftmigration2&as_channel=dpcft&as_campclass=brand&as_source=ft_web&as_camptype=acquisition&as_audience=users&as_content=closure_asset-detail-page">Photo Source</a>
</div>

---
class: center
### Age data

```{r age-data, out.width = 900}

ss <- tidy_ages_weighted(dat$survey_samples,
                         dat_survey_sets = dat$survey_sets,
                         sample_type = "survey")

ss$survey_abbrev <- factor(ss$survey_abbrev)
s_ages <- plot_ages(ss,
  line_col = c("M" = "#0000FF", "F" = "#FF0000"),
  survey_cols = NULL
  # survey_cols = stats::setNames(
  #   c("#FC8D62", "#FC8D62", "#FC8D62", "#FC8D62"),
  #   c("SYN WCHG", "SYN HS", "SYN QCS", "SYN WCVI")
  # )
) +
  facet_wrap(~survey_abbrev, nrow = 1, scales = "free_x") +
  guides(fill = "none", colour = "none") +
  theme(plot.title = element_blank(),
        axis.title = element_blank())

sc <- tidy_ages_weighted(comm_ss,
                         dat_catch = dat$catch,
                         sample_type = "commercial") |> 
  mutate(survey_abbrev = "Shoreside")

sf <- tidy_ages_weighted(comm_ft,
                         dat_catch = dat$catch,
                         sample_type = "commercial") |>
  mutate(survey_abbrev = "Freezer Trawlers")

sb <- suppressWarnings(bind_rows(sc, sf))

sb$survey_abbrev <- factor(sb$survey_abbrev)

c_ages <- plot_ages(sb, 
  line_col = c("M" = "#0000FF", "F" = "#FF0000"),
  survey_cols = NULL
  # survey_cols = stats::setNames(
  #   # c("black", "black"), 
  #   c("#0096FF", "#0096FF"),
  #   c("Freezer Trawlers", "Shoreside"))
  ) +
  guides(fill = "none", colour = "none") +
  theme(plot.title = element_blank(),
        axis.title = element_blank())

grid.arrange(s_ages,
             c_ages,
             nrow = 2,
             # heights = c(1.1,1),
             left = tr("Ages (years)"),
             bottom = tr("Year sampled"))
```

---
class: center, bg_surveys
### Abundance Indices

.left[
Five fishery independent indices of abundance were fit in the base model:

- `r qcs`: odd years, 2003&ndash;2021 and 2004

- `r hsmas`: 1996, 1998, 2000,2002, 2003

- `r hss`: odd years, 2005&ndash;2021

- `r wcvis`: even years, 2004&ndash;2018, and 2021

- `r dcpue`: all years, 1996&ndash;2021


All are in thousands of tonnes except the `r dcpue` which is in kg/hr.
]
<div class="footer" id="a">
  <a href="https://www.researchgate.net/figure/Locations-of-the-current-groundfish-trawl-surveys-on-the-coast-of-British-Columbia_fig1_237497699">Photo Source</a>
</div>

---
class: center
### Length/Weight fits by sex

```{r length-weight, out.width = 900}

if(!exists("data_dir")){
  stop("`data_dir` does not exist. If running from command line, ",
       "source('index.Rmd') to set up all project variables", call. = FALSE)
}
lw_fn <- file.path(data_dir, "fit_lw_output.rds")
if(file.exists(lw_fn)){
  lw_lst <- readRDS(lw_fn)  
}else{
  lw_lst <- list(
    fit_length_weight(filter(survey_samples, survey_abbrev %in% "SYN QCS"), sex = "female"),
    fit_length_weight(filter(survey_samples, survey_abbrev %in% "SYN QCS"), sex = "male"),
    fit_length_weight(filter(survey_samples, survey_abbrev %in% "SYN HS"), sex = "female"),
    fit_length_weight(filter(survey_samples, survey_abbrev %in% "SYN HS"), sex = "male"),
    fit_length_weight(filter(survey_samples, survey_abbrev %in% "SYN WCVI"), sex = "female"),
    fit_length_weight(filter(survey_samples, survey_abbrev %in% "SYN WCVI"), sex = "male"),
    fit_length_weight(survey_samples_syn, sex = "female"),
    fit_length_weight(survey_samples_syn, sex = "male"))
  saveRDS(lw_lst, lw_fn)
}
lw_title_lst <- list(
  tr("SYN QCS (5AB)"),
  tr("SYN HS (5CD)"),
  tr("SYN WCVI (3CD)"),
  tr("Coastwide"))

plot_lw_panels <- function(lw_f, lw_m){
  plot_length_weight(object_female = lw_f,
                     object_male = lw_m,
                     col = c("Female" = "#FF0000", "Male" = "#0000FF"),
                     pts_col = TRUE,
                     french = fr()) +
    guides(colour = "none", fill = "none", lty = "none") +
    
    # coord_cartesian(xlim = c(0, 85), ylim = c(0, 6.7)) +
    xlim(0, 85) +
    theme(axis.title = element_blank())
}

lw_plot_lst <- list(
  plot_lw_panels(lw_lst[[1]], lw_lst[[2]]) +
  ggtitle(lw_title_lst[[1]]),
  
  plot_lw_panels(lw_lst[[3]], lw_lst[[4]]) +
  ggtitle(lw_title_lst[[2]]),
  
  plot_lw_panels(lw_lst[[5]], lw_lst[[6]]) +
  ggtitle(lw_title_lst[[3]]),

  plot_lw_panels(lw_lst[[7]], lw_lst[[8]]) +
  ggtitle(lw_title_lst[[4]]))

grid.arrange(grobs = lw_plot_lst,
             ncol = 2,
             bottom = paste0(tr("Length"), " (cm)"),
             left = tr("Weight (kg)"))

```

---
class: center
### Length/Age fits

```{r vb-fits, out.width = 900}

if(!exists("data_dir")){
  stop("`data_dir` does not exist. If running from command line, ",
       "source('index.Rmd') to set up all project variables", call. = FALSE)
}
vb_fn <- file.path(data_dir, "fit_vb_output.rds")
if(file.exists(vb_fn)){
  vb_lst <- readRDS(vb_fn)  
}else{
  vb_lst <- list(
    fit_vb(filter(survey_samples, survey_abbrev %in% "SYN QCS")),
    fit_vb(filter(survey_samples, survey_abbrev %in% "SYN QCS"), sex = "male"),
    fit_vb(filter(survey_samples, survey_abbrev %in% "SYN HS")),
    fit_vb(filter(survey_samples, survey_abbrev %in% "SYN HS"), sex = "male"),
    fit_vb(filter(survey_samples, survey_abbrev %in% "SYN WCVI")),
    fit_vb(filter(survey_samples, survey_abbrev %in% "SYN WCVI"), sex = "male"),
    fit_vb(survey_samples_syn),
    fit_vb(survey_samples_syn, sex = "male"))
  saveRDS(vb_lst, vb_fn)
}
vb_title_lst <- list(
  tr("SYN QCS (5AB)"),
  tr("SYN HS (5CD)"),
  tr("SYN WCVI (3CD)"),
  tr("Coastwide"))

plot_vb_panels <- function(vb_f, vb_m){
  plot_vb(object_female = vb_f,
          object_male = vb_m,          
          col = c("Female" = "#FF0000", "Male" = "#0000FF"),
          pts_col = TRUE,
          french = fr()) +
    guides(colour = "none", fill = "none", lty = "none") +
    theme(axis.title = element_blank()) +
    coord_cartesian(xlim = c(0, 25), ylim = c(0, 75))
}

vb_plot_lst <- list(
  plot_vb_panels(vb_lst[[1]], vb_lst[[2]]) +
  ggtitle(vb_title_lst[[1]]),
  
  plot_vb_panels(vb_lst[[3]], vb_lst[[4]]) +
  ggtitle(vb_title_lst[[2]]),
  
  plot_vb_panels(vb_lst[[5]], vb_lst[[6]]) +
  ggtitle(vb_title_lst[[3]]),

  plot_vb_panels(vb_lst[[7]], vb_lst[[8]]) +
  ggtitle(vb_title_lst[[4]]))

grid.arrange(grobs = vb_plot_lst,
             ncol = 2,
             left = paste0(tr("Length"), " (cm)"),
             bottom = tr("Age (years)"))
```

---
class: center
### Age and length-at maturity ogives

```{r mat-fits, out.width = 900}

mat_fn <- file.path(data_dir, "fit_mat_ogive_output.rds")
if(file.exists(mat_fn)){
  mat_lst <- readRDS(mat_fn)
}else{
  mat_lst <- list(
    fit_mat_ogive(filter(survey_samples, survey_abbrev %in% "SYN QCS")),
    fit_mat_ogive(filter(survey_samples, survey_abbrev %in% "SYN QCS"), type = "length"),
    fit_mat_ogive(filter(survey_samples, survey_abbrev %in% "SYN HS")),
    fit_mat_ogive(filter(survey_samples, survey_abbrev %in% "SYN HS"), type = "length"),
    fit_mat_ogive(filter(survey_samples, survey_abbrev %in% "SYN WCVI")),
    fit_mat_ogive(filter(survey_samples, survey_abbrev %in% "SYN WCVI"), type = "length"),
    fit_mat_ogive(survey_samples_syn),
    fit_mat_ogive(survey_samples_syn, type = "length"))
  saveRDS(mat_lst, mat_fn)
}
mat_title_lst <- list(
  tr("SYN QCS (5AB)"),
  "",
  tr("SYN HS (5CD)"),
  "",
  tr("SYN WCVI (3CD)"),
  "",
  tr("Coastwide synoptic trawl surveys"),
  "")

plot_mat_panels <- function(fit_obj){
  p <- plot_mat_ogive(fit_obj,  
          col = c("F" = "#FF0000", "M" = "#0000FF"),
                      show_quant_text = FALSE) +
    guides(colour = "none", fill = "none", lty = "none") +
    ggplot2::guides(lty = "none", colour = "none") + 
    theme(axis.title.y = element_blank())
  p
}

ma_plot_lst <- list(
  plot_mat_panels(mat_lst[[1]]) +
  coord_cartesian(xlim = c(0, 18), ylim = c(0, 1)) +
  theme(axis.title = element_blank()) +
  ggtitle(mat_title_lst[[1]]),

  plot_mat_panels(mat_lst[[2]]) +
  coord_cartesian(xlim = c(0, 82), ylim = c(0, 1)) +
  theme(axis.title = element_blank()) +
  ggtitle(mat_title_lst[[2]]),

  plot_mat_panels(mat_lst[[3]]) +
  coord_cartesian(xlim = c(0, 18), ylim = c(0, 1)) +
  theme(axis.title = element_blank()) +
  ggtitle(mat_title_lst[[3]]),

  plot_mat_panels(mat_lst[[4]]) +
  coord_cartesian(xlim = c(0, 82), ylim = c(0, 1)) +
  theme(axis.title = element_blank()) +
  ggtitle(mat_title_lst[[4]]),

  plot_mat_panels(mat_lst[[5]]) +
  coord_cartesian(xlim = c(0, 18), ylim = c(0, 1)) +
  theme(axis.title = element_blank()) +
  ggtitle(mat_title_lst[[5]]),

  plot_mat_panels(mat_lst[[6]]) +
  coord_cartesian(xlim = c(0, 82), ylim = c(0, 1)) +
  theme(axis.title = element_blank()) +
  ggtitle(mat_title_lst[[6]]),

  plot_mat_panels(mat_lst[[7]]) +
  coord_cartesian(xlim = c(0, 18), ylim = c(0, 1)) +
  ggtitle(mat_title_lst[[7]]) +
  xlab(tr("Age (years)")),

  plot_mat_panels(mat_lst[[8]]) +
  coord_cartesian(xlim = c(0, 82), ylim = c(0, 1)) +
  ggtitle(mat_title_lst[[8]]) +
  xlab(paste0(tr("Length"), " (cm)")))

grid.arrange(grobs = ma_plot_lst,
             ncol = 2,
             left = paste0(tr("Probability mature")))
```

---
class: center
### Growth Parameters fit externally

```{r growth-params-table, results = "asis", eval = as.logical(length(grep("grandin", user)))}

# This is a necessary step when compiling a latex table in HTML!
tex2markdown <- function(texstring) {
  writeLines(text = texstring,
             con = myfile <- tempfile(fileext = ".tex"))
  texfile <- pandoc(input = myfile, format = "html")
  cat(readLines(texfile), sep = "\n")
  unlink(c(myfile, texfile))
}

tex_table <- table_growth_params(base_model,
                                 digits = 3,
                                 alpha_digits = 7,
                                 booktabs = FALSE,
                                 longtable = FALSE,
                                 repeat_header = FALSE,
                                 bold_header = FALSE,
                                 cap = "")
tex2markdown(tex_table)
```

---
class: center
### Proportion female

```{r prop-female-table-left, results = "asis"}
t1 <- table_prop_female(prop_female_lst,
                        digits = 2,
                        longtable = FALSE,
                        format = "html",
                        font_size = 14,
                        caption = "",
                        yrs = 1996:2007)
t2 <- table_prop_female(prop_female_lst,
                        digits = 2,
                        longtable = FALSE,
                        format = "html",
                        font_size = 14,
                        caption = "",
                        yrs = 2008:2019)
cat(c('<table><tr valign="top"><td>',
      t1,
      '</td><td>',
      t2,
      '</td><tr></table>'),
    sep = '')
```
.left[
The overall mean of the survey and the commercial fishery means is <SPAN STYLE="font-size:18.0pt">0.79</SPAN>

This was input into the ISCAM base model.
]

---
class: center, middle, inverse
# Bridge Models

---
class: center
### Bridge models - group 1

.left[
- Bridge models were run to move from the model used in the `r la` to this year's assessment.
- Each of the 10 models has one has only one change to the model from the previous one.
]
```{r bridge-biomass-group1, out.width = "70%"}
cowplot::plot_grid(
  plot_biomass_mcmc(models$bridge_grps[[1]],
                    legend_title = "Models",
                    angle_x_labels = TRUE,
                    leg_loc = c(0.95, 0.95),
                    ylim = c(0, 1000)) +
    theme(legend.key.size = unit(0.1, 'cm')),
  plot_biomass_mcmc(models$bridge_grps[[1]],
                    rel = TRUE,
                    leg_loc = NULL,
                    angle_x_labels = TRUE,
                    ylim = c(0, 1.5)),
  ncol = 2)

```

---
class: center
### Bridge models - Pairs plot resulting from adding data to 2021

```{r bridge-biomass-pairs-add2021data, out.width = "80%"}
plot_pairs_mcmc(models$bridge_grps[[1]][[3]],
                plot_sel = FALSE,
                param_rm = c("m1", "m2", "rho", "ssb",
                             "msy1", "msy2",
                             "fmsy1", "fmsy2",
                             "umsy1", "umsy2",
                             "bmsy", "bo", "sbo", "vartheta",
                             "so", "beta", "phie"),
                text_title_size = NULL,
                tick_label_size = 4,
                point_size = 0.5)
```

---
class: center
### Bridge models - group 2

```{r bridge-biomass-group2, out.width = "80%"}
cowplot::plot_grid(
  plot_biomass_mcmc(models$bridge_grps[[2]],
                    legend_title = "Models",
                    angle_x_labels = TRUE,
                    leg_loc = c(0.95, 0.95),
                    ylim = c(0, 280)) +
    theme(legend.key.size = unit(0.1, 'cm')),
  plot_biomass_mcmc(models$bridge_grps[[2]],
                    rel = TRUE,
                    leg_loc = NULL,
                    angle_x_labels = TRUE,
                    ylim = c(0, 1.5)),
  ncol = 2)
```

---
class: center
### Bridge models - Index fits for group 2 models

```{r bridge-index-group2, out.width = "85%", eval = as.logical(length(grep("grandin", user)))}
plot_index_mcmc(models$bridge_grps[[2]],
                type = "fits",
                surv_index = survey_index,
                leg_loc = "outside",
                angle_x_labels = TRUE,
                text_title_size = NULL)
```

---
class: center
### Bridge models - Selectivity estimates for split-sex model
```{r bridge-group2-sel, out.width = "60%"}
plot_selex_mcmc(models$bridge_grps[[2]][[4]],
                show_maturity = TRUE,
                leg_loc = "facet")
```

.left[
- The selectivity age-at-50% estimates $(\hat{a})$ for females and males in the `r wchgs` for this model were (median, CI [credible interval]) `r split_sex_model_sel_ahat_wchg_female_html` and `r split_sex_model_sel_ahat_wchg_male_html` respectively.
]

---
class: center
### Bridge models - group 3

```{r bridge-biomass-group3, out.width = "80%"}
cowplot::plot_grid(
  plot_biomass_mcmc(models$bridge_grps[[3]],
                    legend_title = "Models",
                    angle_x_labels = TRUE,
                    leg_loc = c(0.95, 0.95),
                    ylim = c(0, 280)) +
    theme(legend.key.size = unit(0.1, 'cm')),
  plot_biomass_mcmc(models$bridge_grps[[3]],
                    rel = TRUE,
                    leg_loc = NULL,
                    angle_x_labels = TRUE,
                    ylim = c(0, 1.5)),
  ncol = 2)
```

---
class: center
### Bridge models - Pairs plot resulting from removing WCHG

```{r fig-bridge-pairs-remove-wchg, out.width = "70%"}
plot_pairs_mcmc(models$bridge_grps[[3]][[2]],
                plot_sel = FALSE,
                param_rm = c("rho", "ssb",
                             "msy1", "msy2",
                             "fmsy1", "fmsy2",
                             "umsy1", "umsy2",
                             "bmsy", "bo", "sbo", "vartheta",
                             "so", "beta", "phie"),
                text_title_size = NULL,
                tick_label_size = 4,
                point_size = 0.5)
```
.left[
- This model has excessive correlation between parameters.
- M estimate of `r estimated_male_m_remove_wchg$est` for males is too low for this stock compared to surrounding areas, and should be higher than the female estimate, `r estimated_female_m_remove_wchg$est`.
]

---
class: center
### Bridge models - Pairs plot resulting from fixing M

```{r fig-bridge-pairs-fix-m, out.width = "70%"}
plot_pairs_mcmc(models$bridge_grps[[3]][[3]],
                plot_sel = FALSE,
                param_rm = c("m1", "m2", "rho", "ssb",
                             "msy1", "msy2",
                             "fmsy1", "fmsy2",
                             "umsy1", "umsy2",
                             "bmsy", "bo", "sbo", "vartheta",
                             "so", "beta", "phie"),
                text_title_size = NULL,
                tick_label_size = 4,
                point_size = 0.5)
```
.left[
- Fixed M to 0.20 for females and 0.35 for males as in the GOA and Bering Sea/Aleutian Islands assessment.
- A higher male M is supported by a lack of older males in the survey and trawl data
]

---
class: center
### Bridge models - All models

```{r bridge-biomass-all, out.width = "80%"}
all_bridge_mdls <- do.call(c, models$bridge_grps[-4])
class(all_bridge_mdls) <- mdl_lst_cls
cowplot::plot_grid(
  plot_biomass_mcmc(all_bridge_mdls,
                    legend_title = "Models",
                    angle_x_labels = TRUE,
                    leg_loc = c(0.95, 0.95),
                    palette = "Paired",
                    show_ci = FALSE,
                    ylim = c(0, 1000)) +
    theme(legend.key.size = unit(0.1, 'cm')),
  plot_biomass_mcmc(all_bridge_mdls,
                    rel = TRUE,
                    leg_loc = NULL,
                    palette = "Paired",
                    show_ci = FALSE,
                    angle_x_labels = TRUE,
                    ylim = c(0, 1.5)),
  ncol = 2)
```

---
class: center, bg_arf_pencil_flip
### Bridge models - Summary

.left[
The base model is the last bridge model and includes all changes made across the set of bridge models which include:

- switch to .link-style1[[gfdata](https://github.com/pbs-assess/gfdata)]/.link-style1[[gfplot](https://github.com/pbs-assess/gfplot)] methods for data extraction;
- updated age, catch, and index data to include 2015&ndash;2021;
- the Dirichlet-Multinomial age weighting parameterization;
- two-fleets for commercial trawl fishery (Freezer trawlers and Shoreside);
- addition of the Discard CPUE index;
- split-sex model;
- fishing year runs from Feb. 21 - Feb. 20 (instead of Jan. 1 - Dec. 31);
- removal of all data from `r wchgs` and
- fixed natural mortality for both sexes (0.2 for females and 0.35 for males)
]
<div class="footer" id="a">
  <a href="https://stock.adobe.com/images/arrowtooth-flounder-atheresthes-stomas-a-flatfish-from-the-north-pacific-in-top-view/317577516?as_campaign=ftmigration2&as_channel=dpcft&as_campclass=brand&as_source=ft_web&as_camptype=acquisition&as_audience=users&as_content=closure_asset-detail-page">Photo Source</a>
</div>

---
class: center, middle, inverse
# Base model

---
class: center
### Base model - Abundance index fits

```{r index-fits-base, out.width = 900}
plot_index_mcmc(base_model,
                type = "fits",
                surv_index = survey_index,
                leg_loc = NULL,
                text_title_size = NULL)
```

---
class: center
### Base model - Abundance index residuals

```{r index-residuals-base, out.width = 900}
plot_index_mcmc(base_model,
                type = "resids",
                surv_index = survey_index,
                leg_loc = NULL,
                text_title_size = NULL)
```

---
class: center
### Base model - Age fits/residuals for Freezer trawlers
.left-fig[
```{r age-fits-base-ft, out.width = "100%", fig.dim = c(4.8, 4.5)}
plot_age_fits_mcmc(base_model, gear = 1,
                   text_title_size = NULL,
                   angle_x_labels = TRUE) +
  ylim(c(0, 0.3))
```
]
.right-fig[
```{r age-resids-base-ft, out.width = "100%", fig.dim = c(4.8, 4.5)}
plot_age_resids_mcmc(base_model,
                     gear = 1,
                     text_title_size = NULL)
```
]

---
class: center
### Base model - Age fits for Shoreside
.left-fig[
```{r age-fits-base-ss-1, out.width = "100%", fig.dim = c(4.8, 4.5)}
plot_age_fits_mcmc(base_model,
                   gear = 2,
                   yrs = 1996:2007,
                   text_title_size = NULL,
                   angle_x_labels = TRUE) +
  ylim(c(0, 0.3))
```
]
.right-fig[
```{r age-fits-base-ss-2, out.width = "100%", fig.dim = c(4.8, 4.5)}
plot_age_fits_mcmc(base_model,
                   gear = 2,
                   yrs = 2008:2021,
                   text_title_size = NULL,
                   angle_x_labels = TRUE) +
  ylim(c(0, 0.3))
```
]

---
class: center
### Base model - Age residuals for Shoreside

```{r age-resids-base-ss, out.width = 900}
plot_age_resids_mcmc(base_model,
                     gear = 2,
                     text_title_size = NULL)
```

---
class: center
### Base model - Age fits/residuals for QCS Synoptic survey
.left-fig[
```{r age-fits-base-qcs, out.width = "100%", fig.dim = c(4.8, 4.5)}
plot_age_fits_mcmc(base_model,
                   gear = 3,
                   text_title_size = NULL,
                   angle_x_labels = TRUE) +
  ylim(c(0, 0.3))
```
]
.right-fig[
```{r age-resids-base-qcs, out.width = "100%", fig.dim = c(4.8, 4.5)}
plot_age_resids_mcmc(base_model,
                     gear = 3,
                     text_title_size = NULL)
```
]

---
class: center
### Base model - Age fits/residuals for HS Synoptic survey
.left-fig[
```{r age-fits-base-hss, out.width = "100%", fig.dim = c(4.8, 4.5)}
plot_age_fits_mcmc(base_model,
                   gear = 4,
                   text_title_size = NULL,
                   angle_x_labels = TRUE) +
  ylim(c(0, 0.3))
```
]
.right-fig[
```{r age-resids-base-hss, out.width = "100%", fig.dim = c(4.8, 4.5)}
plot_age_resids_mcmc(base_model,
                     gear = 4,
                     text_title_size = NULL)
```
]

---
class: center
### Base model - Age fits/residuals for WCVI Synoptic survey
.left-fig[
```{r age-fits-base-wcvi, out.width = "100%", fig.dim = c(4.8, 4.5)}
plot_age_fits_mcmc(base_model,
                   gear = 5,
                   text_title_size = NULL,
                   angle_x_labels = TRUE) +
  ylim(c(0, 0.3))
```
]
.right-fig[
```{r age-resids-base-wcvi, out.width = "100%", fig.dim = c(4.8, 4.5)}
plot_age_resids_mcmc(base_model,
                     gear = 5,
                     text_title_size = NULL)
```
]

---
class: center
### Base model - Dirichlet Multinomial parameters and effective sample sizes, 1996&ndash;2007

```{r mcmc-base-dm-1, results = "asis"}
table_param_phi_mpd(base_model,
                    format = "html",
                    cap = "",
                    yrs = 1996:2007,
                    escape = FALSE) |>
  kable_styling(font_size = 18)
```

---
class: center
### Base model - Dirichlet Multinomial parameters and effective sample sizes, 2008&ndash;2021

```{r mcmc-base-dm-2, results = "asis"}
table_param_phi_mpd(base_model,
                    format = "html",
                    cap = "",
                    yrs = 2008:2021) |>
      kable_styling(font_size = 18)
```

---
class: center
### Base model - Selectivity estimates
.left[
Selectivities were estimated for the gears with age compositions; the two trawl fleets and the three synoptic surveys (not including WCHG).
- Maturities are shown on the plots (dashes lines) to show why the vulnerable biomass was estimated so small, the selectivities are almost all estimated to the right of the maturities, especially the males.
- Single blue lines represent fixed selectivities; both sexes were fixed the the same value.

```{r selex-base, out.width = "60%"}
plot_selex_mcmc(base_model, show_maturity = TRUE, leg_loc = "facet")
```
]

---
class: center
### Base model - Reference point estimates
.left[
- The $U_{MSY_2}$ posteriors (exploitation rate) for the Shoreside fleet are all at or near 1, meaning the fishing mortality is unrealistically large.
- This implies that no amount of fishing would impact the stock, and is why the MSY-based reference points are so liberal.

```{r ref-points-base, out.width = "60%" }
plot_ref_points(base_model)
```
]

---
class: center, middle, inverse
# Base Model &mdash; MCMC diagnostics

---
class: center
### Base model - Priors and Posteriors

```{r mcmc-base-priors-posts, out.width = "70%"}
plot_priors_posts_mcmc(base_model,
                       param_rm = c("sel",
                                    "bo",
                                    "tau",
                                    "sigma",
                                    "log_m_sex1",
                                    "log_m_sex2",
                                    "so", "beta", "phie"),
                       text_title_size = NULL)
```
.left[
- Subscript on catchability  parameters, $q_k$:
- $k$ = Gear: $1$ = QCS Synoptic, $2$ = HS Multi. Assemb., $3$ = HS Synoptic, $4$ = WCVI Synoptic, $5$ = Discard CPUE
]

---
class: center
### Base model - Traceplots, leading parameters

```{r mcmc-base-trace, out.width = "70%"}
plot_traces_mcmc(base_model,
                 plot_sel = FALSE, 
                 param_rm = c("m1", "m2", "rho", "ssb", "vartheta",
                              "bo", "msy1", "msy2", "fmsy1", "fmsy2",
                              "umsy1", "umsy2","bmsy",
                              "so", "beta", "phie"),
                 text_title_size = NULL)
```
.left[
- Subscript on catchability  parameters, $q_k$:
- $k$ = Gear: $1$ = QCS Synoptic, $2$ = HS Multi. Assemb., $3$ = HS Synoptic, $4$ = WCVI Synoptic, $5$ = Discard CPUE
]

---
class: center
### Base model - Traceplots, selectivity parameters
```{r mcmc-base-trace-selex, out.width = "65%"}
plot_traces_mcmc(base_model,
                 plot_sel = TRUE, 
                 text_title_size = NULL)
```
.left[
- Subscripts on selectivity parameters, $\hat{a}_{g,s,t}$ and $\hat{\gamma}_{g,s,t}$:
  - $g$ = Gear: $1$ = Freezer trawlers, $2$ = Shoreside, $3$ = QCS Synoptic, $5$ = HS Synoptic, $6$ = WCVI Synoptic
  - $s$ = Sex: $f$ = Female, $m$ = Male
  - $t$ = Time block (for TV selectivity, all are $1$ here because base model has time-invariant selectivity)
]

---
class: center
### Base model - Autocorrelation, leading parameters

```{r mcmc-base-autocor, out.width = "70%"}
plot_autocorr_mcmc(base_model,
                   plot_sel = FALSE, 
                   param_rm = c("m1", "m2", "rho", "ssb", "vartheta",
                                "bo", "msy1", "msy2", "fmsy1", "fmsy2",
                                "umsy1", "umsy2","bmsy",
                                "so", "beta", "phie"),
                   rows_cols = c(3, 4),
                   text_title_size = NULL,
                   lag_max = 1000,
                   col = "blue",
                   lwd = 2)
```
.left[
- Subscript on catchability  parameters, $q_k$:
- $k$ = Gear: $1$ = QCS Synoptic, $2$ = HS Multi. Assemb., $3$ = HS Synoptic, $4$ = WCVI Synoptic, $5$ = Discard CPUE
]

---
class: center
### Base model - Autocorrelation, selectivity parameters

```{r mcmc-base-autocor-selex, out.width = "65%"}
plot_autocorr_mcmc(base_model, 
                   plot_sel = TRUE, 
                   text_title_size = NULL,
                   lag_max = 1000,
                   col = "blue",
                   lwd = 2)
```
.left[
- Subscripts on selectivity parameters, $\hat{a}_{g,s,t}$ and $\hat{\gamma}_{g,s,t}$:
  - $g$ = Gear: $1$ = Freezer trawlers, $2$ = Shoreside, $3$ = QCS Synoptic, $5$ = HS Synoptic, $6$ = WCVI Synoptic
  - $s$ = Sex: $f$ = Female, $m$ = Male
  - $t$ = Time block (for TV selectivity, all are $1$ here because base model has time-invariant selectivity)
]

---
class: center
### Pairs plot - base model, leading parameters
```{r fig-base-pairs, out.width = "70%"}
plot_pairs_mcmc(base_model,
                plot_sel = FALSE,
                param_rm = c("m1", "m2", "rho", "ssb",
                             "msy1", "msy2",
                             "fmsy1", "fmsy2",
                             "umsy1", "umsy2",
                             "bmsy", "bo", "sbo", "vartheta",
                             "so", "beta", "phie"),
                text_title_size = NULL,
                tick_label_size = 4,
                point_size = 0.5)
```
.left[
- Subscript on catchability  parameters, $q_k$:
- $k$ = Gear: $1$ = QCS Synoptic, $2$ = HS Multi. Assemb., $3$ = HS Synoptic, $4$ = WCVI Synoptic, $5$ = Discard CPUE
]

---
class: center
### Pairs plot - base model, selectivity parameters
```{r fig-base-pairs-sel, out.width = "65%"}
# Remove 4 and 7 because they are fixed in the model (HSMAS and DCPUE indices) and will produce NAs
plot_pairs_mcmc(base_model,
                plot_sel = TRUE,
                param_rm = c("selage4_male_block1",
                             "selage4_female_block1",
                             "selsd4_male_block1",
                             "selsd4_female_block1",
                             "selage7_male_block1",
                             "selage7_female_block1",
                             "selsd7_male_block1",
                             "selsd7_female_block1"),
                text_title_size = NULL,
                tick_label_size = 4,
                point_size = 0.25)
```
.left[
- Subscripts on selectivity parameters, $\hat{a}_{g,s,t}$ and $\hat{\gamma}_{g,s,t}$:
  - $g$ = Gear: $1$ = Freezer trawlers, $2$ = Shoreside, $3$ = QCS Synoptic, $5$ = HS Synoptic, $6$ = WCVI Synoptic
  - $s$ = Sex: $f$ = Female, $m$ = Male
  - $t$ = Time block (for TV selectivity, all are $1$ here because base model has time-invariant selectivity)
]

---
class: center
### Comparison of Base model and single sex model (bridge model 2)

```{r mcmc-base-vs-single-sex-biomass, out.width = "80%"}
cowplot::plot_grid(
  plot_biomass_mcmc(models$sens_grps[[7]],
                    append_txt = " (Split sex, two fleets)",
                    ylim = c(0, 300),
                    show_bo_lines = TRUE,
                    leg_loc = c(0.95, 0.95),
                    angle_x_labels = TRUE),
  plot_biomass_mcmc(models$sens_grps[[7]],
                    append_base_txt = " (Split sex, two fleets)",
                    ylim = c(0, 1.3),
                    show_bo_lines = TRUE,
                    leg_loc = c(0.95, 0.95),
                    angle_x_labels = TRUE,
                    rel = TRUE),
  ncol = 2)
```

---
class: center, middle, inverse
# Retrospective models

---
class: center
### Retrospectives - Spawning biomass
```{r fig-retro-biomass, out.width = "85%"}
plot_biomass_mcmc(models$retro_grps[[1]],
                  angle_x_labels = TRUE,
                  text_title_size = NULL,
                  show_bo_lines = TRUE,
                  line_width = 0.5,
                  point_size = 1,
                  palette = "Paired",
                  leg_loc = c(0.95, 0.95),
                  bo_refpt_colors = c("salmon", "darkgreen"),
                  ylim = c(0, 500))

```

---
class: center
### Retrospectives - Spawning biomass, closer view
```{r fig-retro-biomass-closer, out.width = "85%"}
plot_biomass_mcmc(models$retro_grps[[1]],
                  angle_x_labels = TRUE,
                  text_title_size = NULL,
                  show_bo_lines = TRUE,
                  line_width = 1,
                  point_size = 2,
                  palette = "Paired",
                  leg_loc = NULL,
                  bo_refpt_colors = c("salmon", "darkgreen"),
                  ylim = c(0, 250))

```

---
class: center
### Retrospectives - Relative spawning biomass
```{r fig-retro-biomass-rel, out.width = "85%"}
plot_biomass_mcmc(models$retro_grps[[1]],
                  angle_x_labels = TRUE,
                  text_title_size = NULL,
                  show_bo_lines = TRUE,
                  rel = TRUE,
                  line_width = 0.5,
                  point_size = 1,
                  palette = "Paired",
                  leg_loc = NULL,
                  bo_refpt_colors = c("salmon", "darkgreen"),
                  ylim = c(0, 1.3))

```

---
class: center
### Retrospectives - Recruitment
```{r fig-retro-recr, out.width = "85%"}
plot_recr_mcmc(models$retro_grps[[1]],
               angle_x_labels = TRUE,
               text_title_size = NULL,
               line_width = 0.5,
               point_size = 1.5,
               palette = "Paired",
               leg_loc = c(0.05, 0.95))
```

---
class: center
### Retrospectives - Recruitment, closer view
```{r fig-retro-recr-closer, out.width = "85%"}
plot_recr_mcmc(models$retro_grps[[1]],
               angle_x_labels = TRUE,
               text_title_size = NULL,
               line_width = 0.25,
               point_size = 1,
               palette = "Paired",
               leg_loc = NULL,
               ylim = c(0, 340))
```

---
class: center
### Retrospectives - Fishing mortality by fleet
```{r fig-retro-f, out.width = "85%"}
plot_f_mcmc(models$retro_grps[[1]],
            angle_x_labels = TRUE,
            text_title_size = NULL,
            line_width = 0.5,
            point_size = 1.5,
            palette = "Paired",
            leg_loc = c(0.05, 0.95))
```

---
class: center
### Retrospectives - Index fits
```{r fig-retro-index-fits, out.width = "85%"}
plot_index_mcmc(models$retro_grps[[1]],
                type = "fits",
                surv_index = survey_index,
                leg_loc = "facet",
                text_title_size = NULL,
                fit_line_width = 0.25,
                fit_point_size = 1.5,
                palette = "Paired",
                errbar_width = 0.1,
                dodge = 0.1)
```

---
class: center
### Retrospectives - Trace plots for 2019 model
```{r fig-base-trace-selex, out.width = "85%"}
plot_traces_mcmc(models$retro_grps[[1]][[5]],
                 plot_sel = TRUE, 
                 text_title_size = NULL)
```

---
class: center
### Retrospectives - Pairs plot for 2019 model
```{r fig-base-pairs-retro, out.width = "85%"}
plot_pairs_mcmc(models$retro_grps[[1]][[5]],
                plot_sel = FALSE,
                param_rm = c("m1", "m2", "rho", "ssb",
                             "msy1", "msy2",
                             "fmsy1", "fmsy2",
                             "umsy1", "umsy2",
                             "bmsy", "bo", "sbo", "vartheta",
                             "so", "beta", "phie"),
                text_title_size = NULL,
                tick_label_size = 4,
                point_size = 0.5)
```

---
class: center
### Comparison of 2015 model and retrospective for 2015

```{r base-2015-vs-retro, out.width = "80%"}
cowplot::plot_grid(
  plot_biomass_mcmc(models$bridge_grps[[4]],
                    ylim = c(0, 600),
                    leg_loc = c(0.95, 0.95),
                    angle_x_labels = TRUE),
  plot_biomass_mcmc(models$bridge_grps[[4]],
                    ylim = c(0, 1.3),
                    show_bo_lines = TRUE,
                    leg_loc = c(0.95, 0.95),
                    angle_x_labels = TRUE,
                    rel = TRUE),
  ncol = 2)
```

---
class: center, middle, inverse
# Sensitivity models

---
class: center
### Sensitivity group 1 - Spawning biomass
```{r fig-sens1, out.width = "70%"}
plot_biomass_mcmc(models$sens_grps[[1]],
                  angle_x_labels = TRUE,
                  text_title_size = NULL,
                  show_bo_lines = TRUE,
                  line_width = 0.5,
                  point_size = 1.5,
                  leg_loc = c(0.95, 0.95),
                  ylim = c(0, 300))
```
.left[
- Two $B_0$ values were left off the plot for clarity.
- They are estimated as 445 (236â602) thousand t and 370 (200â581) thousand t for the "Decrease $\sigma$ to 0.135" and "Increase $\tau$ to 1.0" respectively.

]

---
class: center
### Sensitivity group 1 - Relative spawning biomass
```{r fig-sens1-rel, out.width = "85%"}
plot_biomass_mcmc(models$sens_grps[[1]],
                  rel = TRUE,
                  angle_x_labels = TRUE,
                  text_title_size = NULL,
                  show_bo_lines = TRUE,
                  line_width = 0.5,
                  point_size = 1.5,
                  leg_loc = c(0.95, 0.95),
                  ylim = c(0, 1.3))
```


---
class: center
### Reducing steepness prior mean from 0.8 to 0.72 - Priors vs. Posteriors
```{r sens-steepness-prior, out.width = "65%"}
cowplot::plot_grid(
plot_priors_posts_mcmc(base_model,
                       param_rm = c("sel",
                                    "bo",
                                    "tau",
                                    "sigma",
                                    "log_m_sex1",
                                    "log_m_sex2",
                                    "so", "beta", "phie")),
plot_priors_posts_mcmc(models$sens_grps[[1]][[5]],
                       param_rm = c("sel",
                                    "bo",
                                    "tau",
                                    "sigma",
                                    "log_m_sex1",
                                    "log_m_sex2",
                                    "so", "beta", "phie")),
ncol = 2)
```
.left[
- Subscript on catchability  parameters, $q_k$:
- $k$ = Gear: $1$ = QCS Synoptic, $2$ = HS Multi. Assemb., $3$ = HS Synoptic, $4$ = WCVI Synoptic, $5$ = Discard CPUE
]


---
class: center
### Sensitivity group 3 - Spawning biomass
```{r fig-sens3, out.width = "85%"}
plot_biomass_mcmc(models$sens_grps[[3]],
                  angle_x_labels = TRUE,
                  text_title_size = NULL,
                  show_bo_lines = TRUE,
                  line_width = 0.5,
                  point_size = 1.5,
                  leg_loc = c(0.95, 0.95),
                  ylim = c(0, 350))
```

---
class: center
### Sensitivity group 3 - Relative spawning biomass
```{r fig-sens3-rel, out.width = "85%"}
plot_biomass_mcmc(models$sens_grps[[3]],
                  rel = TRUE,
                  angle_x_labels = TRUE,
                  text_title_size = NULL,
                  show_bo_lines = TRUE,
                  line_width = 0.5,
                  point_size = 1.5,
                  leg_loc = c(0.95, 0.95),
                  ylim = c(0, 1.3))
```

---
class: center
### Sensitivity group 3 - Catchability estimates
```{r fig-sens3-q, out.width = "85%"}
plot_q_mcmc(models$sens_grps[[3]],
            leg_loc = "facet",
            gear = NULL)
```

---
class: center
### Sensitivity group 4 - Spawning biomass
```{r fig-sens4, out.width = "85%"}
plot_biomass_mcmc(models$sens_grps[[4]],
                  angle_x_labels = TRUE,
                  text_title_size = NULL,
                  show_bo_lines = TRUE,
                  line_width = 0.5,
                  point_size = 1.5,
                  leg_loc = c(0.95, 0.95),
                  ylim = c(0, 700))
```

---
class: center
### Sensitivity group 4 - Relative spawning biomass
```{r fig-sens4-rel, out.width = "85%"}
plot_biomass_mcmc(models$sens_grps[[4]],
                  rel = TRUE,
                  angle_x_labels = TRUE,
                  text_title_size = NULL,
                  show_bo_lines = TRUE,
                  line_width = 0.5,
                  point_size = 1.5,
                  leg_loc = c(0.95, 0.95),
                  ylim = c(0, 3))
```

---
class: center
### Sensitivity group 4 - Vulnerable biomass
```{r fig-sens4-vuln, out.width = "70%"}
plot_vuln_mcmc(models$sens_grps[[4]][[2]],
               angle_x_labels = TRUE,
               leg_loc = c(0.95, 0.95),
               xlim = c(1997, 2021),
               ylim = c(0, 800))
```
.left[
- The two trawl fleets have their selectivity set equal so their vulnerable biomasses overlap
- The ratio of the sum of the two fleetsâ vulnerable biomasses to the spawning biomass in 2021 is `r f(sel_eq_mat_vuln_ratio, 2)`
- For the base model, this ratio is `r f(base_model_vuln_ratio, 2)`
]

---
class: center
### Sensitivity group 4 - Index fits
```{r fig-sens4-index-fits, out.width = "85%"}
plot_index_mcmc(models$sens_grps[[4]],
                type = "fits",
                surv_index = survey_index,
                leg_loc = "facet",
                text_title_size = NULL)

```

---
class: center
### Sensitivity To QCS time-varying selectivity - Selectivity estimates
```{r fig-sens4-qcs-tv-selex, out.width = "85%"}
plot_selex_gear_mcmc(models$sens_grps[[4]][[3]], gear = 3, show_maturity = TRUE)
```

---
class: center
### Sensitivity To QCS time-varying selectivity - Trace plots
```{r fig-sens4-qcs-trace, out.width = "85%"}
plot_traces_mcmc(models$sens_grps[[4]][[3]],
                 plot_sel = TRUE, 
                 text_title_size = NULL,
                 col = "blue",
                 lwd = 2)
```

---
class: center
### Sensitivity for Geostatistical-based index - Spawning biomass
```{r fig-sens5, out.width = "85%"}
plot_biomass_mcmc(models$sens_grps[[5]],
                  angle_x_labels = TRUE,
                  text_title_size = NULL,
                  show_bo_lines = TRUE,
                  line_width = 0.5,
                  point_size = 1.5,
                  leg_loc = c(0.95, 0.95),
                  ylim = c(0, 280))
```

---
class: center
### Sensitivity for Geostatistical-based index - Relative spawning biomass
```{r fig-sens5-rel, out.width = "85%"}
plot_biomass_mcmc(models$sens_grps[[5]],
                  rel = TRUE,
                  angle_x_labels = TRUE,
                  text_title_size = NULL,
                  show_bo_lines = TRUE,
                  line_width = 0.5,
                  point_size = 1.5,
                  leg_loc = c(0.95, 0.95),
                  ylim = c(0, 1.3))
```

---
class: center
### Sensitivity  for Geostatistical-based index - Index fits
```{r fig-sens5-index-fits, out.width = "85%"}
plot_index_mcmc(models$sens_grps[[5]][[2]],
                type = "fits",
                surv_index = survey_index_geo,
                leg_loc = NULL,
                text_title_size = NULL)

```

---
class: center, middle, inverse
### Projections, decision table, and summary

---
class: center
### Decision table and figure of outcomes
.left-fig[
```{r decision-table, results = "asis"}
table_decisions(base_model,
                format = "html",
                digits = 3,
                font_size = 10,
                caption = "")
```
]
.right-fig[
```{r fig-proj-tac, out.width = "100%"}
plot_dfo_ref_point_figure(base_model)
```
.left[
- Thick lines are the 50% CI
- Thin lines are the 95% CI
- Points are medians
]
]

---
class: center, bg_arf
### Summary
.left[
- The inclusion of the 2015&ndash;2021 data are what changes the model the most
- The abundance has been declining sharply in the survey indices since 2018
- The discard CPUE shows a decline since 2013
- TAC was reduced to 5,000 t in 2020
- The spawning biomass has flattened out since 2020
- Recruitment is highly uncertain for 2020 and 2021
- The QCS survey index is difficult to fit, as it is not declining in the same way as other indices
- The QCS selectivity is estimated poorly in the retrospectives prior to 2019, and some sensitivities
- There is a lack of older males in the data which the model explains with a high M on males

**Thanks**

We thank members of the Arrowtooth Flounder Technical Working Group (Robyn Forrest, Rowan Haigh, Paul Starr, Diedre Finn, Rob Tadey, Bruce Turris, and Brian Mose) for their valuable advice and insights throughout this project. We thank members of the Sclerochronology Laboratory at the Pacific Biological Station for their processing of Arrowtooth Flounder otoliths.

We thank the reviewers for their careful reviews, which uncovered structural issues that would have otherwise been missed. This highlights the importance of independent peer review in the advisory process.
]
<div class="footer" id="a">
  <a href="https://www.seafoodwatch.org/recommendation/flounder/arrowtooth-flounder-525">Photo Source</a>
</div>
