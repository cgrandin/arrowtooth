# Bridging analysis

The base model from the 2015 assessment was run with the newest version of the iSCAM code and the original data files and the results were determined to be identical.

Various modifications were made incrementally to the 2015 base model to create a set of bridging models which evaluate the component-specific effects of all changes from the 2015 base model to the 2021 base model.

As a reminder, the 2015 base model was a female-only catch-at-age model with 4 indices of abundance which included the three Synoptic surveys and the Hecate Strait Multispecies assemblage survey.

## Two-fleet split-sex models

Each model in this section is based on the previous one with only one change made so incremental changes can be tracked.

1. 2015 Base model

1. Extracted the data for the 2015 model using the **gfplot** package, which has been used in several assessments and in the **gfsynopsis** report. Ran the 2015 model without any modifications other than this data change.

1. Using the same data extraction methods as in the first step, appended data up to and including 2021.

1. Switched the age comp likelihood from Multivariate Normal Logistic to Dirichlet-Multinomial

1. Add the WCHG Synoptic survey index and age comps

1. Change the model to two fleets. This splits the commercial trawl catch into catch from Freezer Trawlers (FT COMM) and wet boats (WB COMM).

1. Added the Discard CPUE index. This was suggested by the Technical Working Group (TWG) and is an index for vessels that were not fishing for `r sp` and therefore were discarding all that they caught incidentally. The selectivity could not reliably be estimated for this index in the current model configuration, so its selectivity was fixed to values representative of other estimated selectivities from other gears (Table \@ref(tab:bridge4-sel-param-table)). The values fixed were Age-at-50% = 9 for Females and 6 for Males.

1. Convert model to split-sex.

1. Change fishing year to Feb. 21 - Feb 20.

1. Fixed male Natural mortality to be 0.2, and female to be 0.35. These are the values that are used in the Gulf of Alaska assessment.

(ref:fig-bridge4-biomass) Maximum Posterior Density (MPD) estimates of spawning biomass (top panel) and relative spawning biomass (bottom panel). Points on the left represent $R_0$ values.

(ref:fig-bridge4-biomass-french) French caption here

```{r bridge4-biomass, fig.cap = ifelse(french, "(ref:fig-bridge4-biomass-french)", "(ref:fig-bridge4-biomass)"), out.width = "100%" , fig.pos="H"}
cowplot::plot_grid(
  plot_ts_mpd(models$bridge_models[[4]],
              type = "sbt",
              legend_title = "Bridge models"),
  plot_ts_mpd(models$bridge_models[[4]],
              type = "sbt",
              rel = TRUE,
              legend_title = "Bridge models") +
    coord_cartesian(ylim = c(0, 1)), nrow = 2)
```

(ref:fig-bridge4-recruitment) Maximum Posterior Density (MPD) estimates of recruitment. Points on the left represent $R_0$ estimates.

(ref:fig-bridge4-recruitment-french) French caption here

```{r bridge4-recruitment, fig.cap = ifelse(french, "(ref:fig-bridge4-recruitment-french)", "(ref:fig-bridge4-recruitment)"), out.width = "100%" , fig.pos="H"}
plot_ts_mpd(models$bridge_models[[4]],
            type = "rt",
            legend_title = "Bridge models") +
  coord_cartesian(ylim = c(0, 2.2))
```

(ref:fig-bridge4-index-fits) Maximum Posterior Density (MPD) index fits. The black points on the red line with associated envelope represents the index data points and CVs as calculated using the bootstrapping method included in the GFBioSQL database. The lines themselves are just connecting the points and they are not meant to represent data between the points. They are a visual aid only.

(ref:fig-bridge4-index-fits-french) French caption here

```{r bridge4-index-fits, fig.cap = ifelse(french, "(ref:fig-bridge4-index-fits-french)", "(ref:fig-bridge4-index-fits)"), out.width = "100%" , fig.pos="H"}
plot_index_fit_mpd(models$bridge_models[[4]],
                   surv_index = survey_index,
                   legend_title = "Bridge models")
```

<!-- ```{r bridge4-param-settings-table, results = 'asis'} -->
<!-- param_settings_table( -->
<!--   models$bridge_models[[4]][[2]], -->
<!--   format = "latex", -->
<!--   font_size = 7, -->
<!--   caption = ifelse( -->
<!--     french, -->
<!--     "French goes here", -->
<!--     "Number of parameters estimated, bounds, and prior parameterizations for the model 'Convert model to split sex (two fleets)'.")) -->
<!-- ``` -->

```{r bridge4-param-table, results = 'asis'}
param_est_mpd_table(
  models$bridge_models[[4]],
  format = "latex",
  digits = 3,
  font_size = 5,
  model_col_widths = "5em",
  caption = ifelse(
    french,
    "French goes here",
    "Bridge model parameter estimates for the primary parameters, reference points, and catchability estimates ($q$) for each index. The table follows tracks changes from left to right in the same order as the plots."))
```

```{r bridge4-phi-table-9, results = 'asis'}
param_phi_mpd_table(models$bridge_models[[4]],
                    neff = TRUE,
                    which_model = 9,
                    font_size = 7,
                    format = "latex",
                    caption = paste0("Effective sample sizes by gear for the '",
                                     names(models$bridge_models[[4]])[9],
                                     "' model by gear, year, and sex. ",
                                     "Calculated from the $log\\_phi$ parameter of the Dirichlet Multinomial likelihood. ",
                                     "Dashes represent no age comps for those gear/year/sex combinations."))
```

```{r bridge4-phi-table-10, results = 'asis'}
param_phi_mpd_table(models$bridge_models[[4]],
                    neff = TRUE,
                    which_model = 10,
                    font_size = 7,
                    format = "latex",
                    caption = paste0("Effective sample sizes by gear for the '",
                                     names(models$bridge_models[[4]])[10],
                                     "' model by gear, year, and sex. ",
                                     "Calculated from the $log\\_phi$ parameter of the Dirichlet Multinomial likelihood. ",
                                     "Dashes represent no age comps for those gear/year/sex combinations."))
```

\begin{landscapepage}
```{r bridge4-likelihoods, results = 'asis'}
likelihood_table(models$bridge_models[[4]],
                 model_col_widths = "4em",
                 font_size = 5,
                 format = "latex",
                 caption = "Negative log likelihoods included in the objective function for each model.")
```
\end{landscapepage}

\clearpage

(ref:fig-bridge4-selectivities) Maximum Posterior Density (MPD) maturity ogives and selectivity estimates for all gears. The dashed blue and red lines are the male and female maturity ogives respectively, the blue and red lines with points are the yearly selectivity estimates for males and females respectively. The Discard CPUE and HSMSA indices have fixed selectivities in all models.

```{r bridge4-selectivities, fig.cap = "(ref:fig-bridge4-selectivities)"}
plist <- map2(models$bridge_models[[4]], names(models$bridge_models[[4]]), ~{
  plot_selex(.x, show_maturity = TRUE, title = .y) +
    theme(plot.title = element_text(face = "bold", size = 12),
          axis.text.x = element_text(size = 6),
          strip.text.x = element_text(size = 6))
})
n <- length(plist)
nrow <- floor(sqrt(n))
do.call("grid.arrange", c(plist, ncol = nrow))
```

(ref:fig-bridge4-selectivity-possible-base) Closer view of the Maximum Posterior Density (MPD) maturity ogives and selectivity estimates for the '`r names(models$bridge_models[[4]])[9]`` model'.

```{r selectivity-possible-base, fig.cap = "(ref:fig-bridge4-selectivity-possible-base)"}
plot_selex(models$bridge_models[[4]][[9]],
           show_maturity = TRUE,
           title = names(models$bridge_models[[4]])[9]) +
  theme(plot.title = element_text(face = "bold", size = 12),
        axis.text.x = element_text(size = 6),
        strip.text.x = element_text(size = 6))
```

(ref:fig-bridge4-selectivity-possible-base-2) Closer view of the Maximum Posterior Density (MPD) maturity ogives and selectivity estimates for the '`r names(models$bridge_models[[4]])[10]`` model'.

```{r selectivity-possible-base-2, fig.cap = "(ref:fig-bridge4-selectivity-possible-base-2)"}
plot_selex(models$bridge_models[[4]][[10]],
           show_maturity = TRUE,
           title = names(models$bridge_models[[4]])[10]) +
  theme(plot.title = element_text(face = "bold", size = 12),
        axis.text.x = element_text(size = 6),
        strip.text.x = element_text(size = 6))
```

```{r bridge4-sel-param-table, results = 'asis'}
sel_param_est_mpd_table(
  models$bridge_models[[4]],
  format = "latex",
  digits = 3,
  font_size = 7,
  model_col_widths = "5em",
  caption = ifelse(
    french,
    "French goes here",
    "A comparison of Bridge model selectivity parameter estimates.")) %>%
  column_spec(1, width = "8em")
```

\clearpage

(ref:fig-bridge4-age-fit-1) Maximum Posterior Density (MPD) age comp fits for the '`r names(models$bridge_models[[4]])[9]``' model, for the 'FT COMM' gear.

```{r bridge4-agefit-1, fig.cap = "(ref:fig-bridge4-age-fit-1)"}
plot_agecomp_fits_splitsex(models$bridge_models[[4]][[9]], 1)
```

(ref:fig-bridge4-age-fit-2) Maximum Posterior Density (MPD) age comp fits for the '`r names(models$bridge_models[[4]])[9]``' model, for the 'WB COMM' gear.

```{r bridge4-agefit-2, fig.cap = "(ref:fig-bridge4-age-fit-2)", fig.asp = 1.4}
plot_agecomp_fits_splitsex(models$bridge_models[[4]][[9]], 2)
```

(ref:fig-bridge4-age-fit-3) Maximum Posterior Density (MPD) age comp fits for the '`r names(models$bridge_models[[4]])[9]``' model, for the 'SYN QCS' gear.

```{r bridge4-agefit-3, fig.cap = "(ref:fig-bridge4-age-fit-3)"}
plot_agecomp_fits_splitsex(models$bridge_models[[4]][[9]], 3)
```

(ref:fig-bridge4-age-fit-5) Maximum Posterior Density (MPD) age comp fits for the '`r names(models$bridge_models[[4]])[9]``' model, for the 'SYN HS' gear.

```{r bridge4-agefit-5, fig.cap = "(ref:fig-bridge4-age-fit-5)"}
plot_agecomp_fits_splitsex(models$bridge_models[[4]][[9]], 5)
```
(ref:fig-bridge4-age-fit-6) Maximum Posterior Density (MPD) age comp fits for the '`r names(models$bridge_models[[4]])[9]``' model, for the 'SYN WCVI' gear.

```{r bridge4-agefit-6, fig.cap = "(ref:fig-bridge4-age-fit-6)"}
plot_agecomp_fits_splitsex(models$bridge_models[[4]][[9]], 6)
```

(ref:fig-bridge4-age-fit-7) Maximum Posterior Density (MPD) age comp fits for the '`r names(models$bridge_models[[4]])[9]``' model, for the 'SYN WCHG' gear.

```{r bridge4-agefit-7, fig.cap = "(ref:fig-bridge4-age-fit-7)"}
plot_agecomp_fits_splitsex(models$bridge_models[[4]][[9]], 7)
```
(ref:fig-bridge4-age-comp-2) Weighted age compositions for the 'FT COMM' fleet.

```{r bridge4-agecomp-2, fig.cap = "(ref:fig-bridge4-age-comp-2)"}
comm_ft <- extract_fleet_samples(commercial_samples)
catch_ft <- extract_fleet_catch(catch)

tidy_ages_weighted(comm_ft,
                   sample_type = "commercial",
                   dat_catch = catch_ft) %>%
  plot_ages()
```

(ref:fig-bridge4-age-comp-3) Weighted age compositions for the 'WB COMM' fleet.

```{r bridge4-agecomp-3, fig.cap = "(ref:fig-bridge4-age-comp-3)"}
comm_nonft <- extract_fleet_samples(commercial_samples, include = FALSE)
catch_nonft <- extract_fleet_catch(catch, include = FALSE)

tidy_ages_weighted(comm_nonft,
                   sample_type = "commercial",
                   dat_catch = catch_nonft) %>%
  plot_ages()
```

(ref:fig-bridge4-age-comp-4) Weighted age compositions for the 'SYN QCS' survey.

```{r bridge4-agecomp-4, fig.cap = "(ref:fig-bridge4-age-comp-4)"}
tidy_ages_weighted(survey_samples,
                   survey = "SYN QCS",
                   sample_type = "survey",
                   dat_survey_sets = survey_sets) %>%
  plot_ages()
```

(ref:fig-bridge4-age-comp-5) Weighted age compositions for the 'SYN HS' survey.

```{r bridge4-agecomp-5, fig.cap = "(ref:fig-bridge4-age-comp-5)"}
tidy_ages_weighted(survey_samples,
                   survey = "SYN HS",
                   sample_type = "survey",
                   dat_survey_sets = survey_sets) %>%
  plot_ages()
```

(ref:fig-bridge4-age-comp-6) Weighted age compositions for the 'SYN WCVI' survey.

```{r bridge4-agecomp-6, fig.cap = "(ref:fig-bridge4-age-comp-6)"}
tidy_ages_weighted(survey_samples,
                   survey = "SYN WCVI",
                   sample_type = "survey",
                   dat_survey_sets = survey_sets) %>%
  plot_ages()
```

(ref:fig-bridge4-age-comp-7) Weighted age compositions for the 'SYN WCHG' survey.

```{r bridge4-agecomp-7, fig.cap = "(ref:fig-bridge4-age-comp-7)"}
tidy_ages_weighted(survey_samples,
                   survey = "SYN WCHG",
                   sample_type = "survey",
                   dat_survey_sets = survey_sets) %>%
  plot_ages()
```

\clearpage

