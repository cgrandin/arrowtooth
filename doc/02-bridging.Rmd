# Overview of bridging steps

The base model from the 2015 assessment was run with the newest version of the iSCAM code and the original data files and the results were determined to be identical.

Various modifications were made incrementally to the 2015 base model to create a set of bridging models which evaluate the component-specific effects of all changes from the 2015 base model to the 2021 base model.

As a reminder, the 2015 base model was a female-only catch-at-age model with 4 indices of abundance which included the three Synoptic surveys and the Hecate Strait Multispecies assemblage survey.

Each model in this list is based on the previous one with only one change made so incremental changes can be tracked.

1. 2015 Base model

1. Extracted the data for the 2015 model using the **gfplot** package, which has been used in several assessments and in the **gfsynopsis** report. Ran the 2015 model without any modifications other than this data change.

1. Using the same data extraction methods as in the first step, appended data up to and including 2021.

1. Switched the age comp likelihood from Multivariate Normal Logistic to Dirichlet-Multinomial

1. Add the WCHG Synoptic survey index and age comps

1. Change the model to two fleets. This splits the commercial trawl catch into catch from Freezer Trawlers (FT COMM) and wet boats (WB COMM).

1. Added the Discard CPUE index. This was suggested by the Technical Working Group (TWG) and is an index for vessels that were not fishing for `r sp` and therefore were discarding all that they caught incidentally. The selectivity could not reliably be estimated for this index in the current model configuration, so its selectivity was fixed to values representative of other estimated selectivities from other gears (Table \@ref(tab:bridge-sel-param-table)). The values fixed were Age-at-50% = 9 for Females and 6 for Males.

1. Convert model to split-sex.

1. Change fishing year to Feb. 21 - Feb 20.

1. Fixed male Natural mortality to be 0.2, and female to be 0.35. These are the values that are used in the Gulf of Alaska assessment.

# Biomass and Recruitment

The absolute and relative biomass plots (Figure \@ref(fig:bridge-biomass)) show that the data that were available in 2014 when the 2015 stock assessment was being prepared produced a model with increasing biomass, partly due to the indices being at high levels and partly because the recruitment (Figure \@ref(fig:bridge-recruitment)) was being predicted as quite large for 2011. The large 2011 recruitment estimate was due to the high uncertainty from lack of data in that model. iSCAM will add biomass through recruitment when data are limited and biomass has to be accounted for to fit the indices. There were 18 years of catch data and only a few index points available at the time the 2015 model was run.

Note that the extra large recruitment for 2013 which is not fully exposed in the figure (~3.5 million) was never included in the model output advice in 2015 because iSCAM overwrites the final year recruitment with average recruitment in the projection model for the final year.

The historical data changes between 2014 and 2021 (the light blue and dark blue lines) are caused mainly by slightly different proportions female applied, and changes in the indices of abundance for the synoptic surveys due to blocks being removed from the surveys in subsequent years. The female proportions are different due to only 'Unsorted' samples being used in 2021; in 2015 all samples were included. The trajectories for the two models is similar for both biomass and recruitment, and the biomass estimates are almost the same in both absolute and relative terms.

All the models which include data to 2021 (the third through tenth ones) are very similar in absolute biomass, with some differences in the $B_0$ estimates which scale the relative biomass trajectories with respect to one another. The recruitment trajectories for those models are very similar with only the model which fixes M (purple) having a divergent estimate for $R_0$. This can be checked in Table \@ref(tab:bridge-param-table) where the $R_0$ estimates are all approximately 0.19. In the 2015 model, $R_0$ estimates were much higher at 0.67. This can be explained by iSCAM behaviour in absence of enough time series data.

(ref:fig-bridge-biomass) Maximum Posterior Density (MPD) estimates of spawning biomass (top panel) and relative spawning biomass (bottom panel). Points on the left represent $R_0$ values.

(ref:fig-bridge-biomass-french) French caption here

```{r bridge-biomass, fig.cap = ifelse(french, "(ref:fig-bridge-biomass-french)", "(ref:fig-bridge-biomass)"), out.width = "100%" , fig.pos="H"}
mdl_grp <- 1
cowplot::plot_grid(
  plot_ts_mpd(models$bridge_models[[mdl_grp]],
              type = "sbt",
              legend_title = "Bridge models"),
  plot_ts_mpd(models$bridge_models[[mdl_grp]],
              type = "sbt",
              rel = TRUE,
              legend_title = "Bridge models") +
    coord_cartesian(ylim = c(0, 1)), nrow = 2)
```

(ref:fig-bridge-recruitment) Maximum Posterior Density (MPD) estimates of recruitment. Points on the left represent $R_0$ estimates.

(ref:fig-bridge-recruitment-french) French caption here

```{r bridge-recruitment, fig.cap = ifelse(french, "(ref:fig-bridge-recruitment-french)", "(ref:fig-bridge-recruitment)"), out.width = "100%" , fig.pos="H"}
plot_ts_mpd(models$bridge_models[[mdl_grp]],
            type = "rt",
            legend_title = "Bridge models") +
  coord_cartesian(ylim = c(0, 1.6))
```

# Index fits

The Hecate Strait Synoptic survey (SYN HS) is fit by all models with almost all estimates lying within the uncertainty bars. Even though the last two estimates miss the index points and associated uncertainty range, the downward trend of the index is being captured. The Queen Charlotte Sound Synoptic survey (SYN QCS) is fit well until the last few index points, where the estimates follow the overall downward trend of the model and miss the index points. This could be possibly be improved with a multi-area model, as it has been suggested this is a nursery stock which is separate from the main coastwide stock but we are not able to produce that due to data and time limitations. This index will never fit correctly at the end in this single-area coastwide model where the other indices are decreasing.

The West Coast Vancouver Island Synoptic survey (SYN WCVI) has some large swings in data from low biomass to high biomass in subsequent survey years. This is extremely hard for a model to fit and this model splits the difference with its fits, as it should, and also follows the downward trend observed by the surveys.

The Discard CPUE (DCPUE) has the most data points and gives a clear biomass trend which is fit very well by the model. This index of abundance is clearly driving the model fits as the same pattern can be seen in fits to other survey indices.

The $q$ estimates range from 0.1 to 0.25 for all of these models and surveys (Table \@ref(tab:bridge-param-table)), with the exception of the West Coast Haida Gwaii Synoptic survey (SYN WCHG) which has very low $q$ estimates. Selectivity for this survey was difficult to estimate because there are only two years' worth of age comp data for it.

(ref:fig-bridge-index-fits) Maximum Posterior Density (MPD) index fits. The black points with bars represent the index data points and CVs as calculated using the bootstrapping method included in the GFBioSQL database. The lines representing the fits are just connecting the point estimates and they are not meant to represent data between the points. They are a visual aid only.

(ref:fig-bridge-index-fits-french) French caption here

```{r bridge-index-fits, fig.cap = ifelse(french, "(ref:fig-bridge-index-fits-french)", "(ref:fig-bridge-index-fits)"), out.width = "100%" , fig.pos="H"}
plot_index_fit_mpd(models$bridge_models[[mdl_grp]],
                   surv_index = survey_index,
                   legend_title = "Bridge models")
```

<!-- ```{r bridge-param-settings-table, results = 'asis'} -->
<!-- param_settings_table( -->
<!--   models$bridge_models[[mdl_grp]][[2]], -->
<!--   format = "latex", -->
<!--   font_size = 7, -->
<!--   caption = ifelse( -->
<!--     french, -->
<!--     "French goes here", -->
<!--     "Number of parameters estimated, bounds, and prior parameterizations for the model 'Convert model to split sex (two fleets)'.")) -->
<!-- ``` -->

# Parameter estimates

Table \@ref(tab:bridge-param-table) shows that the only major difference in leading parameter estimates occurs with the addition of the 2015-2021 data. This is expected, with the index trajectories descending and catch being reduced each year since 2014. The entire biomass trajectory is scaled down due to the estimate or $R_0$ being so much less than it was in 2015. It is expected that the 2015 estimate of $R_0$ was inflated due to uncertainty introduced by lack of data and that this large difference would likely be much smaller if we had more historical data included in the model in 2015.

The other notable impact model choice has on parameter estimates is fixing the natural mortality parameters to the same values used in the Gulf of Alaska assessment (Male = 0.2, Female = 0.35). This scales all recruitment parameters up. These increases are compensation by the model to account for the increased natural mortality placed on the stock.

```{r bridge-param-table, results = 'asis'}
param_est_mpd_table(
  models$bridge_models[[mdl_grp]],
  format = "latex",
  digits = 3,
  font_size = 5,
  model_col_widths = "5em",
  caption = ifelse(
    french,
    "French goes here",
    "Bridge model parameter estimates for the primary parameters, reference points, and catchability estimates ($q$) for each index. The table follows tracks changes from left to right in the same order as the plots."))
```

# Age compositions and effective sample size

The age composition likelihood for the 2015 model was a Multivariate Logistic Normal (MLN) which applies 'self-weighting' to the age comps based on the conditional maximum likelihood variances in the age proportions.

The Dirichlet-Multinomial ensures that the uncertainty associated with the composition weighting is included in any measures of stock assessment uncertainty.

Composition should not be weighted outside the model because it isn't possible ti quantify the process error, which can make up a substantial proportion of the total error. (Francis 2014)


```{r bridge-phi-table-9, results = 'asis'}
mdl_ind <- 9
param_phi_mpd_table(models$bridge_models[[mdl_grp]],
                    neff = TRUE,
                    which_model = mdl_ind,
                    font_size = 7,
                    format = "latex",
                    caption = paste0("Effective sample sizes by gear for the '",
                                     names(models$bridge_models[[mdl_grp]])[mdl_ind],
                                     "' model by gear, year, and sex. ",
                                     "Calculated from the $log\\_phi$ parameter of the Dirichlet Multinomial likelihood. ",
                                     "Dashes represent no age comps for those gear/year/sex combinations."))
```

```{r bridge-phi-table-10, results = 'asis'}
mdl_ind <- 10
param_phi_mpd_table(models$bridge_models[[mdl_grp]],
                    neff = TRUE,
                    which_model = mdl_ind,
                    font_size = 7,
                    format = "latex",
                    caption = paste0("Effective sample sizes by gear for the '",
                                     names(models$bridge_models[[mdl_grp]])[mdl_ind],
                                     "' model by gear, year, and sex. ",
                                     "Calculated from the $log\\_phi$ parameter of the Dirichlet Multinomial likelihood. ",
                                     "Dashes represent no age comps for those gear/year/sex combinations."))
```

\begin{landscapepage}
```{r bridge-likelihoods, results = 'asis'}
likelihood_table(models$bridge_models[[mdl_grp]],
                 model_col_widths = "4em",
                 font_size = 5,
                 format = "latex",
                 caption = "Negative log likelihoods included in the objective function for each model.")
```
\end{landscapepage}

\clearpage

# Selectivities

## Selectivity figures for all models

(ref:fig-bridge-selectivities) Maximum Posterior Density (MPD) maturity ogives and selectivity estimates for all gears. The dashed blue and red lines are the male and female maturity ogives respectively, the blue and red lines with points are the yearly selectivity estimates for males and females respectively. The Discard CPUE and HSMSA indices have fixed selectivities in all models. This plot shows models 1-5.

```{r bridge-selectivities, fig.cap = "(ref:fig-bridge-selectivities)"}
sub_lst1 <- models$bridge_models[[mdl_grp]][1:5]
nms_sub_lst1 <- names(models$bridge_models[[mdl_grp]])[1:5]
sub_lst2 <- models$bridge_models[[mdl_grp]][6:10]
nms_sub_lst2 <- names(models$bridge_models[[mdl_grp]])[6:10]
plist <- map2(sub_lst1, nms_sub_lst1, ~{
  plot_selex(.x, show_maturity = TRUE, title = .y) +
    theme(plot.title = element_text(face = "bold", size = 12),
          axis.text.x = element_text(size = 6),
          strip.text.x = element_text(size = 6))
})
n <- length(plist)
nrow <- floor(sqrt(n))
do.call("grid.arrange", c(plist, ncol = nrow))
```

(ref:fig-bridge-selectivities-2) Selectivity plots for models 6-10.

```{r bridge-selectivities-2, fig.cap = "(ref:fig-bridge-selectivities-2)"}
plist <- map2(sub_lst2, nms_sub_lst2, ~{
  plot_selex(.x, show_maturity = TRUE, title = .y) +
    theme(plot.title = element_text(face = "bold", size = 12),
          axis.text.x = element_text(size = 6),
          strip.text.x = element_text(size = 6))
})
n <- length(plist)
nrow <- floor(sqrt(n))
do.call("grid.arrange", c(plist, ncol = nrow))
```

## Selectivity fits for select models

(ref:fig-bridge-selectivity-possible-base) Closer view of the Maximum Posterior Density (MPD) maturity ogives and selectivity estimates for the '`r names(models$bridge_models[[mdl_grp]])[mdl_ind]`` model'.

```{r selectivity-possible-base, fig.cap = "(ref:fig-bridge-selectivity-possible-base)"}
plot_selex(models$bridge_models[[mdl_grp]][[mdl_ind]],
           show_maturity = TRUE,
           title = names(models$bridge_models[[mdl_grp]])[mdl_ind]) +
  theme(plot.title = element_text(face = "bold", size = 12),
        axis.text.x = element_text(size = 6),
        strip.text.x = element_text(size = 6))
```

(ref:fig-bridge-selectivity-possible-base-2) Closer view of the Maximum Posterior Density (MPD) maturity ogives and selectivity estimates for the '`r names(models$bridge_models[[mdl_grp]])[10]`` model'.

```{r selectivity-possible-base-2, fig.cap = "(ref:fig-bridge-selectivity-possible-base-2)"}
mdl_ind <- 10
plot_selex(models$bridge_models[[mdl_grp]][[10]],
           show_maturity = TRUE,
           title = names(models$bridge_models[[mdl_grp]])[mdl_ind]) +
  theme(plot.title = element_text(face = "bold", size = 12),
        axis.text.x = element_text(size = 6),
        strip.text.x = element_text(size = 6))
```

\clearpage

```{r bridge-sel-param-table, results = 'asis'}
sel_param_est_mpd_table(
  models$bridge_models[[mdl_grp]],
  format = "latex",
  digits = 3,
  font_size = 7,
  model_col_widths = "5em",
  caption = ifelse(
    french,
    "French goes here",
    "A comparison of Bridge model selectivity parameter estimates.")) %>%
  column_spec(1, width = "8em")

mdl_ind <- 9
```

\clearpage

# Age Composition fits

## Age comp fits, model `r names(models$bridge_models[[mdl_grp]])[mdl_ind]`

(ref:fig-bridge-age-fit-1) Maximum Posterior Density (MPD) age comp fits for the '`r names(models$bridge_models[[mdl_grp]])[mdl_ind]``' model, for the 'FT COMM' gear.

```{r bridge-agefit-1, fig.cap = "(ref:fig-bridge-age-fit-1)"}
plot_agecomp_fits_splitsex(models$bridge_models[[mdl_grp]][[mdl_ind]], 1)
```

(ref:fig-bridge-age-fit-2) Maximum Posterior Density (MPD) age comp fits for the '`r names(models$bridge_models[[mdl_grp]])[mdl_ind]``' model, for the 'WB COMM' gear.

```{r bridge-agefit-2, fig.cap = "(ref:fig-bridge-age-fit-2)", fig.asp = 1.4}
plot_agecomp_fits_splitsex(models$bridge_models[[mdl_grp]][[mdl_ind]], 2)
```

(ref:fig-bridge-age-fit-3) Maximum Posterior Density (MPD) age comp fits for the '`r names(models$bridge_models[[mdl_grp]])[mdl_ind]``' model, for the 'SYN QCS' gear.

```{r bridge-agefit-3, fig.cap = "(ref:fig-bridge-age-fit-3)"}
plot_agecomp_fits_splitsex(models$bridge_models[[mdl_grp]][[mdl_ind]], 3)
```

(ref:fig-bridge-age-fit-5) Maximum Posterior Density (MPD) age comp fits for the '`r names(models$bridge_models[[mdl_grp]])[mdl_ind]``' model, for the 'SYN HS' gear.

```{r bridge-agefit-5, fig.cap = "(ref:fig-bridge-age-fit-5)"}
plot_agecomp_fits_splitsex(models$bridge_models[[mdl_grp]][[mdl_ind]], 5)
```
(ref:fig-bridge-age-fit-6) Maximum Posterior Density (MPD) age comp fits for the '`r names(models$bridge_models[[mdl_grp]])[mdl_ind]``' model, for the 'SYN WCVI' gear.

```{r bridge-agefit-6, fig.cap = "(ref:fig-bridge-age-fit-6)"}
plot_agecomp_fits_splitsex(models$bridge_models[[mdl_grp]][[mdl_ind]], 6)
```

(ref:fig-bridge-age-fit-7) Maximum Posterior Density (MPD) age comp fits for the '`r names(models$bridge_models[[mdl_grp]])[mdl_ind]``' model, for the 'SYN WCHG' gear.

```{r bridge-agefit-7, fig.cap = "(ref:fig-bridge-age-fit-7)"}
plot_agecomp_fits_splitsex(models$bridge_models[[mdl_grp]][[mdl_ind]], 7)
mdl_ind <- 10
```

## Age comp fits, model `r names(models$bridge_models[[mdl_grp]])[mdl_ind]`

(ref:fig-bridge-age-fit-1-1) Maximum Posterior Density (MPD) age comp fits for the '`r names(models$bridge_models[[mdl_grp]])[mdl_ind]``' model, for the 'FT COMM' gear.

```{r bridge-agefit-1-1, fig.cap = "(ref:fig-bridge-age-fit-1-1)"}
plot_agecomp_fits_splitsex(models$bridge_models[[mdl_grp]][[mdl_ind]], 1)
```

(ref:fig-bridge-age-fit-2-1) Maximum Posterior Density (MPD) age comp fits for the '`r names(models$bridge_models[[mdl_grp]])[mdl_ind]``' model, for the 'WB COMM' gear.

```{r bridge-agefit-2-1, fig.cap = "(ref:fig-bridge-age-fit-2-1)", fig.asp = 1.4}
plot_agecomp_fits_splitsex(models$bridge_models[[mdl_grp]][[mdl_ind]], 2)
```

(ref:fig-bridge-age-fit-3-1) Maximum Posterior Density (MPD) age comp fits for the '`r names(models$bridge_models[[mdl_grp]])[mdl_ind]``' model, for the 'SYN QCS' gear.

```{r bridge-agefit-3-1, fig.cap = "(ref:fig-bridge-age-fit-3-1)"}
plot_agecomp_fits_splitsex(models$bridge_models[[mdl_grp]][[mdl_ind]], 3)
```

(ref:fig-bridge-age-fit-5-1) Maximum Posterior Density (MPD) age comp fits for the '`r names(models$bridge_models[[mdl_grp]])[mdl_ind]``' model, for the 'SYN HS' gear.

```{r bridge-agefit-5-1, fig.cap = "(ref:fig-bridge-age-fit-5-1)"}
plot_agecomp_fits_splitsex(models$bridge_models[[mdl_grp]][[mdl_ind]], 5)
```
(ref:fig-bridge-age-fit-6-1) Maximum Posterior Density (MPD) age comp fits for the '`r names(models$bridge_models[[mdl_grp]])[mdl_ind]``' model, for the 'SYN WCVI' gear.

```{r bridge-agefit-6-1, fig.cap = "(ref:fig-bridge-age-fit-6-1)"}
plot_agecomp_fits_splitsex(models$bridge_models[[mdl_grp]][[mdl_ind]], 6)
```

(ref:fig-bridge-age-fit-7-1) Maximum Posterior Density (MPD) age comp fits for the '`r names(models$bridge_models[[mdl_grp]])[mdl_ind]``' model, for the 'SYN WCHG' gear.

```{r bridge-agefit-7-1, fig.cap = "(ref:fig-bridge-age-fit-7-1)"}
plot_agecomp_fits_splitsex(models$bridge_models[[mdl_grp]][[mdl_ind]], 7)
mdl_ind <- 9
```
\clearpage

# Age composition data for all models

(ref:fig-bridge-age-comp-2) Weighted age compositions for the 'FT COMM' fleet.

```{r bridge-agecomp-2, fig.cap = "(ref:fig-bridge-age-comp-2)"}
comm_ft <- extract_fleet_samples(commercial_samples)
catch_ft <- extract_fleet_catch(catch)

tidy_ages_weighted(comm_ft,
                   sample_type = "commercial",
                   dat_catch = catch_ft) %>%
  plot_ages()
```

(ref:fig-bridge-age-comp-3) Weighted age compositions for the 'WB COMM' fleet.

```{r bridge-agecomp-3, fig.cap = "(ref:fig-bridge-age-comp-3)"}
comm_nonft <- extract_fleet_samples(commercial_samples, include = FALSE)
catch_nonft <- extract_fleet_catch(catch, include = FALSE)

tidy_ages_weighted(comm_nonft,
                   sample_type = "commercial",
                   dat_catch = catch_nonft) %>%
  plot_ages()
```

(ref:fig-bridge-age-comp-4) Weighted age compositions for the 'SYN QCS' survey.

```{r bridge-agecomp-4, fig.cap = "(ref:fig-bridge-age-comp-4)"}
tidy_ages_weighted(survey_samples,
                   survey = "SYN QCS",
                   sample_type = "survey",
                   dat_survey_sets = survey_sets) %>%
  plot_ages()
```

(ref:fig-bridge-age-comp-5) Weighted age compositions for the 'SYN HS' survey.

```{r bridge-agecomp-5, fig.cap = "(ref:fig-bridge-age-comp-5)"}
tidy_ages_weighted(survey_samples,
                   survey = "SYN HS",
                   sample_type = "survey",
                   dat_survey_sets = survey_sets) %>%
  plot_ages()
```

(ref:fig-bridge-age-comp-6) Weighted age compositions for the 'SYN WCVI' survey.

```{r bridge-agecomp-6, fig.cap = "(ref:fig-bridge-age-comp-6)"}
tidy_ages_weighted(survey_samples,
                   survey = "SYN WCVI",
                   sample_type = "survey",
                   dat_survey_sets = survey_sets) %>%
  plot_ages()
```

(ref:fig-bridge-age-comp-7) Weighted age compositions for the 'SYN WCHG' survey.

```{r bridge-agecomp-7, fig.cap = "(ref:fig-bridge-age-comp-7)"}
tidy_ages_weighted(survey_samples,
                   survey = "SYN WCHG",
                   sample_type = "survey",
                   dat_survey_sets = survey_sets) %>%
  plot_ages()
```

\clearpage

