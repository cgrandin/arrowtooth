---
title: "Arrowtooth Flounder (*Atheresthes stomias*) Stock Assessment for the West Coast of British Columbia in 2021"
french_title: "Évaluation du stock de la plie à dents de flèche (Atheresthes stomias) sur la côte ouest de la Colombie-Britannique en 2021 Colombie-Britannique en 2021"
author: |
  Chris J. Grandin^1^ and
  Sean C. Anderson^1^
author_list: "Grandin, C.J. and Anderson, S.C."
address: |
  ^1^Pacific Biological Station\
     Fisheries and Oceans Canada, 3190 Hammond Bay Road\
     Nanaimo, British Columbia, V9T 6N7, Canada
french_address: |
  ^1^Station biologique du Pacifique\
     Pêches et Océans Canada, 3190 Hammond Bay Road\
     Nanaimo, Colombie-Britannique, V9T 6N7, Canada\
  \smallskip
  ^2^Loin, très loin\
     Une autre galaxie
month: October
french_month: Octobre
year: 2021
report_number: nnn
region: Pacific Region
french_region: "Région du Pacifique"
isbn: "978-0-660-38322-4"
cat_no: "Fs70-6/2021-012E-PDF"
citation_other_language: "Grandin, C.J. et Anderson, S.C. Title Here (*Latin Species Name*). DFO Secr. can. de consult. sci. du MPO. Doc. de rech 2019/nnn. iv + 13 p."

abstract: |
  Arrowtooth Flounder (*Atheresthes stomias*, Turbot) are an important component of the bottom trawl fishery in British Columbia. They are managed as a coastwide stock, with a TAC of 4,000 t and catch of 10,679 t in 2014. Prior to the introduction of freezer trawlers in the mid-2000s, most of the historical catch of Arrowtooth Flounder is understood to have been discarded at sea. This was largely due to proteolysis, which occurs in the muscle tissue of this species a short time after it is caught, making the flesh unpalatable.

  In the past decade, markets have been established for fillets that have been frozen at sea, and the freezer trawl fleet has taken an increasing proportion of the coastwide catch.

french_abstract: |
  La plie à dents de flèche (*Atheresthes stomias*, Turbot) est une composante importante de la pêche au chalut de fond en Colombie-Britannique. Elle est gérée comme un stock de toute la côte, avec un TAC de 4 000 t et des prises de 10 679 t en 2014. Avant l'introduction des chalutiers congélateurs au milieu des années 2000, on comprend que la plupart des prises historiques de la limande à dents de flèche étaient rejetées en mer. Cela était dû en grande partie à la protéolyse, qui se produit dans le tissu musculaire de cette espèce peu de temps après la capture, rendant la chair peu appétissante.
  
  Au cours de la dernière décennie, des marchés ont été créés pour les filets qui ont été congelés en mer, et la flotte de chalutiers congélateurs a pris une proportion croissante des prises côtières. Traduit avec www.DeepL.com/Translator (version gratuite)

header: "Draft working paper --- Do not cite or circulate" # or "" to omit
output:
 csasdown::resdoc_pdf:
   # build_rds is a toggle to re-build all the RDS files for the models
   build_rds: false
   keep_md: true
   french: false
   # copy_sty is a toggle to copy the style file from the csasdown package every time you compile
   # the document. If false, any changes you have made to the style file in your project
   # will remain between compilations. If true, your changes will be lost when you compile
   copy_sty: true
   # line_nums is a toggle to show line numbers on the left side of the page. 
   line_nums: true
   # line_nums_mod represents showing every Nth line if line_nums is true
   line_nums_mod: 1
   # lot_lof is a toggle to show/not show the lists of tables and figures at the
   # beginning of the document
   lot_lof: false
   # draft_watermark is a toggle to show/not show a DRAFT watermark across every page
   draft_watermark: false
   # include_section_nums, if true includes section numbering in the document body,
   # if false, no numbering in the document body but the TOC will still show numbering
   include_section_nums: true
   # highlight is the theme to use for code output. Must be one of the list given by:
   # pandoc --list-highlight-styles
   # which are:
   # pygments, tango, espresso, zenburn, kate, monochrome, breezedark, haddock
   # or the name of a custom *.latex file which is most easily made by copying one from 
   # the csasdown library 'themes' directory, this directory on your machine:
   # file.path(.libPaths(), "csasdown", "themes")
   # to your working directory (the one containing index.Rmd)
   # To change the foreground text color, change the RGB value in the line containing
   # 'DefineVerbatimEnvironment'
   # To change background color, change the RGB values in the line containing 'shadecolor'
   highlight: tango
# ------------
# End of options to set
knit: (function(input, ...) {
       csasdown::render('_bookdown.yml')
      })
link-citations: true
bibliography: bib/refs.bib
# Any extra LaTeX code for the header:
# header-includes:
# - \usepackage{tikz}
---

```{r setup, echo=FALSE, cache=FALSE, message=FALSE, results='hide', warning=FALSE}
library(knitr)
if (is_latex_output()) {
  knitr_figs_dir <- "knitr-figs-pdf/"
  knitr_cache_dir <- "knitr-cache-pdf/"
  fig_out_type <- "png"
} else {
  knitr_figs_dir <- "knitr-figs-docx/"
  knitr_cache_dir <- "knitr-cache-docx/"
  fig_out_type <- "png"
}
fig_asp <- 0.618
fig_width <- 9
fig_out_width <- "6in"
fig_dpi <- 180
fig_align <- "center"
fig_pos <- "htb"
user <- Sys.getenv("USERNAME")
opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  results = 'hide',
  comment = "#>",
  fig.path = knitr_figs_dir,
  cache.path = knitr_cache_dir,
  fig.asp = fig_asp,
  fig.width = fig_width,
  out.width = fig_out_width,
  echo = FALSE,
  autodep = isTRUE(user == "seananderson"),
  cache = isTRUE(user == "seananderson"),
  cache.comments = FALSE,
  dev = fig_out_type,
  dpi = fig_dpi,
  fig.align = fig_align,
  fig.pos = fig_pos
)
options(# Prevent xtable from adding a timestamp comment to the table code it produces
        xtable.comment = FALSE,
        # Don't allow kableExtra to load packages, we add them manually in csasdown
        kableExtra.latex.load_packages = FALSE,
        # Stop chunk output (echo) running into the margins
        width = 80,
        # Don't use scientific notation (stops tables from showing 1.2e3, etc.)
        scipen = 999)
```

```{r model-setup, cache = FALSE}
library(devtools)
library(gfutilities)
if(user == "grandin"){
  load_all("D:/github/pbs-assess/gfiscamutils/")
}else{
  library(gfiscamutils)
}
library(csasdown)
library(ggplot2)
library(gridExtra)
library(kableExtra)
library(rosettafish)
library(tidylog, warn.conflicts = FALSE)
library(dplyr)
library(purrr)
library(here)
library(gfplot)
devtools::load_all(".")

meta <- rmarkdown::metadata$output
if(is.null(meta)){
  build_rds <- FALSE
}else{
  build_rds <- meta$`csasdown::resdoc_pdf`$build_rds
}

bc <- "British Columbia"
sp <- "Arrowtooth flounder"

# This is a vector of bridge models that will be plotted against each other.
# This must either be NULL or set to a vector of directories

#bridge_models_dirs <- list(c("01-base-2015",
bridge_models_dirs <- list(c("01-base-2015",
                             "02-bridge-update-data-to-2014",
                             "03-bridge-update-data-to-2021",
                             "04-bridge-add-wchg"),
                           c("05-bridge-switch-to-dm-likelihood",
                             "06-bridge-switch-to-2-fleet-model",
                             "07-bridge-add-discard-cpue",
                             "08-bridge-switch-to-split-sex",
                             "09-bridge-switch-fishing-year-to-feb-21-feb-20",
                             "10-bridge-fix-m"))

#bridge_models_text <- list(c("2015 Base model (one fleet, single sex)",
bridge_models_text <- list(c("2015 Base model (one fleet, single sex)",
                             "Update data to 2014 (one fleet, single sex)",
                             "Update data to 2021 (one fleet, single sex)",
                             "Add WCHG survey index and age comps"),
                            c("Switch to DM likelihood (one fleet, single sex)",
                             "Change to two-fleet model (two fleet, single sex)",
                             "Add Discard CPUE index (two fleets, single sex)",
                             "Convert model to split sex (two fleets, split sex)",
                             "Change fishing year to Feb 21 - Feb 20 (two fleets, split sex)",
                             "Fix male M=0.35, female M=0.2 (two fleets, split sex)"))

# Make these factors so that they can be reordered in the legends later
bridge_models_text <- bridge_models_text %>% map(~{factor(.x, levels = .x)})

# This is a list of groups of sensitivities that will be plotted against each other.
# The base model will be prepended to each group later in set_dirs() so that it is first
# on the plots for each group.
# This must either be NULL or set to a list of vectors of directories
sens_models_dirs <- NULL
sens_models_text <- NULL

# Make these factors so that they can be reordered in the legends later
sens_models_text <- sens_models_text %>% map(~{factor(.x, levels = .x)})

if(here() == "/home/rstudio"){
  # For an Rstudio server spawned inside a Docker container
  drs <- set_dirs(nongit_dir = file.path(dirname(here("arrowtooth")), "arrowtooth-nongit"),
                  base_model_dir = "base",
                  bridge_models_dirs = bridge_models_dirs,
                  sens_models_dirs = sens_models_dirs)
}else{
  drs <- set_dirs(base_model_dir = "base",
                  bridge_models_dir = "001-bridge-models",
                  bridge_models_dirs = bridge_models_dirs,
                  sens_models_dirs = sens_models_dirs)
}

models <- model_setup(main_dirs = drs,
                      bridge_models_text = bridge_models_text,
                      sens_models_text = sens_models_text,
                      overwrite = build_rds)

dat <- readRDS(file.path(drs$nongit_dir, "data", "arrowtooth-flounder-oct10-2021.rds"))
# Remove 2014 WCHG index point
dat$survey_index<- dat$survey_index[-which(dat$survey_index$survey_abbrev == "SYN WCHG" & dat$survey_index$year == 2014), ]
 
month_fishing_starts <- 2
day_fishing_starts <- 21

data_dir <- file.path(drs$nongit_dir, "data")
data_output_dir <- file.path(drs$nongit_dir, "data-output")

if(!dir.exists(data_dir)){
  stop("Data directory does not exist: ", data_dir, call. = FALSE)
}
iphc_file <- file.path(data_dir, "iphc-survey-index.rds")
if(!file.exists(iphc_file)){
  stop("IPHC file does not exist: ", iphc_file, call. = FALSE)
}
discard_cpue_file <- file.path(data_dir,
"cpue-predictions-arrowtooth-flounder-modern-3CD5ABCDE-discard-july-26-feb-fishing-year.csv")
#"cpue-predictions-arrowtooth-flounder-modern-3CD5ABCDE-discard-july-26-jan-1-year.csv")
if(!file.exists(discard_cpue_file)){
  stop("Discard CPUE file does not exist: ", discard_cpue_file, call. = FALSE)
}
stitched_syn_file <- file.path(data_dir, "stitched-syn-index.rds")
if(!file.exists(stitched_syn_file)){
  stop("Stitched Synoptics file does not exist: ", stitched_syn_file, call. = FALSE)
}

iphc <- readRDS(iphc_file)$series_ABCD_full$ser_longest
discard_cpue <- read_csv(discard_cpue_file)
stitched_syn <- readRDS(stitched_syn_file)

# These must be removed for call to add_extra_indices()
survey_index <- dat$survey_index %>% 
  select(-species_common_name, -species_science_name)
survey_index <- add_extra_indices(survey_index, 
                                  iphc = iphc,
                                  discard_cpue = discard_cpue,
                                  stitched_syn = stitched_syn)

survey_sets <- dat$survey_sets
survey_samples <- dat$survey_samples
commercial_samples <- dat$commercial_samples
catch <- dat$catch
cpue_spatial <- dat$cpue_spatial
cpue_spatial_ll <- dat$cpue_spatial_ll
age_precision <- dat$age_precision
theme_set(gfiscam_theme())

# Data extraction for iSCAM models:
# extract_survey_indices(survey_index, 
#                        iphc = iphc,
#                        discard_cpue = discard_cpue,
#                        stitched_syn = stitched_syn,
#                        data_path = data_output_dir)


```
