---
title: "Arrowtooth Flounder (*Atheresthes stomias*) Stock Assessment for the West Coast of British Columbia in 2021"
author: |
  Chris J. Grandin^1^ and
  Sean C. Anderson^1^
author_list: "Grandin, C.J. and Anderson, S.C."
address: |
  ^1^Pacific Biological Station\
     Fisheries and Oceans Canada, 3190 Hammond Bay Road\
     Nanaimo, British Columbia, V9T 6N7, Canada
month: October
year: 2021
report_number: nnn
region: Pacific Region
isbn: "978-0-660-38322-4"
citation_other_language: "Grandin, C.J. et Anderson, S.C. Title Here (*Latin Species Name*). DFO Secr. can. de consult. sci. du MPO. Doc. de rech 2019/nnn. iv + 13 p."
abstract: |
  Arrowtooth Flounder(*Atheresthes stomias*, Turbot) are an important component of the bottom trawl fishery in British Columbia. They are managed as a coastwide stock, with a TAC of 4,000 t and catch of 10,679 t in 2014. Prior to the introduction of freezer trawlers in the mid-2000s, most of the historical catch of Arrowtooth Flounder is understood to have been discarded at sea. This was largely due to proteolysis, which occurs in the muscle tissue of this species a short time after it is caught, making the flesh unpalatable. In the past decade, markets have been established for fillets that have been frozen at sea, and the freezer trawl fleet has taken an increasing proportion of the coastwide catch.

header: "Draft working paper --- Do not cite or circulate" # or "" to omit
output:
 csasdown::resdoc_pdf:
   french: false
   copy_sty: true
   line_nums: true
   line_nums_mod: 1
   lot_lof: false
# ------------
# End of options to set
knit: bookdown::render_book
link-citations: true
bibliography: bib/refs.bib
csl: csl/csas.csl # or csl/csas-french.csl for French
# Any extra LaTeX code for the header:
# header-includes:
# - \usepackage{tikz}
---

```{r setup, echo=FALSE, cache=FALSE, message=FALSE, results='hide', warning=FALSE}
library(knitr)
if (is_latex_output()) {
  knitr_figs_dir <- "knitr-figs-pdf/"
  knitr_cache_dir <- "knitr-cache-pdf/"
  fig_out_type <- "png"
} else {
  knitr_figs_dir <- "knitr-figs-docx/"
  knitr_cache_dir <- "knitr-cache-docx/"
  fig_out_type <- "png"
}
fig_asp <- 0.618
fig_width <- 9
fig_out_width <- "6in"
fig_dpi <- 180
fig_align <- "center"
fig_pos <- "htb"
user <- Sys.getenv("USER")
opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  results = 'hide',
  comment = "#>",
  fig.path = knitr_figs_dir,
  cache.path = knitr_cache_dir,
  fig.asp = fig_asp,
  fig.width = fig_width,
  out.width = fig_out_width,
  echo = FALSE,
  autodep = isTRUE(user == "seananderson"),
  cache = isTRUE(user == "seananderson"),
  cache.comments = FALSE,
  dev = fig_out_type,
  dpi = fig_dpi,
  fig.align = fig_align,
  fig.pos = fig_pos
)
options(xtable.comment = FALSE)
options(kableExtra.latex.load_packages = FALSE)
```

```{r load-libraries, cache=FALSE}
options(scipen = 999)
# `french` and `prepub` variables are extracted from the YAML headers above and
#  are used throughout the document. To make the document all in french, change
#  the line in the YAML header above to `french: true`
meta <- rmarkdown::metadata$output
if (length(grep("pdf", names(meta)))) {
  french <- meta$`csasdown::resdoc_pdf`$french
  prepub <- meta$`csasdown::resdoc_pdf`$prepub
} else if (length(grep("word", names(meta)))) {
  french <- meta$`csasdown::resdoc_word`$french
  prepub <- meta$`csasdown::resdoc_word`$prepub
}
csl <- "csl/csas.csl"
if (french) {
  csl <- "csl/csas-french.csl"
  options(OutDec = ",")
}

library(csasdown)
library(gfutilities)
#library(gfiscamutils)
library(ggplot2)
library(gridExtra)
library(kableExtra)
library(rosettafish)
library(tidylog, warn.conflicts = FALSE)
library(dplyr)
library(purrr)
library(here)
library(gfplot)
load_all("C:/github/pbs-assess/gfiscamutils/")
load_all()


sp <- "Arrowtooth flounder"

# This is a vector of bridge models that will be plotted against each other.
# This must either be NULL or set to a vector of directories
bridge_models_dirs <- list(c("01-base",
                             "02-bridge-update-data-to-2014",
                             "03-bridge-update-data-to-2021",
                             "04-bridge-add-wchg",
                             "05-bridge-switch-to-dm-likelihood",
                             "06-bridge-switch-to-2-fleet-model",
                             "07-bridge-add-discard-cpue",
                             "08-bridge-switch-to-split-sex",
                             "09-bridge-switch-fishing-year-to-feb-21-feb-20",
                             "10-bridge-fix-m"))
                             #"11-bridge-remove-wchg-from-09"))

bridge_models_text <- list(c("2015 Base model (one fleet, single sex)",
                             "Update data to 2014 (one fleet, single sex)",
                             "Update data to 2021 (one fleet, single sex)",
                             "Add WCHG survey index and age comps",
                             "Switch to DM likelihood (one fleet, single sex)",
                             "Change to two-fleet model (two fleet, single sex)",
                             "Add Discard CPUE index (two fleets, single sex)",
                             "Convert model to split sex (two fleets, split sex)",
                             "Change fishing year to Feb 21 - Feb 20 (two fleets, split sex)",
                             "Fix male M=0.35, female M=0.2 (two fleets, split sex)"))
                             #"Remove WCHG survey index and age comps"))

# Make these factors so that they can be reordered in the legends later
bridge_models_text <- bridge_models_text %>% map(~{factor(.x, levels = .x)})

# This is a list of groups of sensitivities that will be plotted against each other.
# The base model will be prepended to each group later in set_dirs() so that it is first
# on the plots for each group.
# This must either be NULL or set to a list of vectors of directories
sens_models_dirs <- NULL
sens_models_text <- NULL

# Make these factors so that they can be reordered in the legends later
sens_models_text <- sens_models_text %>% map(~{factor(.x, levels = .x)})

if(here() == "/home/rstudio"){
  drs<- set_dirs(nongit_dir = file.path(dirname(here("arrowtooth")), "arrowtooth-nongit"),
                 base_model_dir = "base",
                 bridge_models_dirs = bridge_models_dirs,
                 sens_models_dirs = sens_models_dirs)
}else{
  drs <- set_dirs(base_model_dir = "base",
                  bridge_models_dirs = bridge_models_dirs,
                  sens_models_dirs = sens_models_dirs)
}

models <- model_setup(main_dirs = drs,
                      bridge_models_text = bridge_models_text,
                      sens_models_text = sens_models_text,
                      overwrite_rds_files = FALSE)

dat <- readRDS(file.path(drs$nongit_dir, "data", "arrowtooth-flounder-aug24-2021.rds"))

month_fishing_starts <- 2
day_fishing_starts <- 21

data_dir <- file.path(drs$nongit_dir, "data")
data_output_dir <- file.path(drs$nongit_dir, "data-output")

if(!dir.exists(data_dir)){
  stop("Data directory does not exist: ", data_dir, call. = FALSE)
}
iphc_file <- file.path(data_dir, "iphc-survey-index.rds")
if(!file.exists(iphc_file)){
  stop("IPHC file does not exist: ", iphc_file, call. = FALSE)
}
discard_cpue_file <- file.path(data_dir,
"cpue-predictions-arrowtooth-flounder-modern-3CD5ABCDE-discard-july-26-feb-fishing-year.csv")
#"cpue-predictions-arrowtooth-flounder-modern-3CD5ABCDE-discard-july-26-jan-1-year.csv")
if(!file.exists(discard_cpue_file)){
  stop("Discard CPUE file does not exist: ", discard_cpue_file, call. = FALSE)
}
stitched_syn_file <- file.path(data_dir, "stitched-syn-index.rds")
if(!file.exists(stitched_syn_file)){
  stop("Stiched Synoptics file does not exist: ", stitched_syn_file, call. = FALSE)
}

iphc <- readRDS(iphc_file)$series_ABCD_full$ser_longest
discard_cpue <- read_csv(discard_cpue_file)
stitched_syn <- readRDS(stitched_syn_file)

# These must be removed for call to add_extra_indices()
survey_index <- dat$survey_index %>% 
  select(-species_common_name, -species_science_name)
survey_index <- add_extra_indices(survey_index, 
                                  iphc = iphc,
                                  discard_cpue = discard_cpue,
                                  stitched_syn = stitched_syn)

survey_sets <- dat$survey_sets
survey_samples <- dat$survey_samples
commercial_samples <- dat$commercial_samples
catch <- dat$catch
cpue_spatial <- dat$cpue_spatial
cpue_spatial_ll <- dat$cpue_spatial_ll
age_precision <- dat$age_precision
theme_set(theme_pbs())

# Data extraction for iSCAM models:
# extract_survey_indices(survey_index, 
#                        iphc = iphc,
#                        discard_cpue = discard_cpue,
#                        stitched_syn = stitched_syn,
#                        data_path = data_output_dir)


```

---
csl: `r csl`    
---
